#!/bin/bash

# =================================
# ED Analytics - Upload .env File to Server
# =================================

set -e  # –ü—Ä–µ–∫—Ä–∞—â–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ

# =================================
# –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø - –ò–ó–ú–ï–ù–ò–¢–ï –ü–û–î –í–ê–® –°–ï–†–í–ï–†
# =================================
SERVER_IP="130.193.46.4"                    # IP –∞–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
SERVER_USER="appuser"                       # –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
SSH_KEY="~/.ssh/llm-cpu/appuser-ed25519"   # –ü—É—Ç—å –∫ SSH –∫–ª—é—á—É
PROJECT_DIR="ed_analytics"                  # –ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
LOCAL_DIR="$(pwd)"                          # –¢–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

echo "üì§ –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É .env —Ñ–∞–π–ª–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
echo "üìç –°–µ—Ä–≤–µ—Ä: ${SERVER_USER}@${SERVER_IP}"
echo ""

# –†–∞—Å–∫—Ä—ã–≤–∞–µ–º —Ç–∏–ª—å–¥—É –≤ –ø—É—Ç–∏ –∫ SSH –∫–ª—é—á—É
SSH_KEY="${SSH_KEY/#\~/$HOME}"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ SSH –∫–ª—é—á–∞
if [ ! -f "$SSH_KEY" ]; then
    echo "‚ùå SSH –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω: $SSH_KEY"
    echo "üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å –∫ –∫–ª—é—á—É –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ .env —Ñ–∞–π–ª–∞
if [ ! -f "$LOCAL_DIR/.env" ]; then
    echo "‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω –≤: $LOCAL_DIR/.env"
    echo "üí° –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ .env —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞"
    exit 1
fi

echo "‚úÖ –§–∞–π–ª .env –Ω–∞–π–¥–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ"
echo ""

# –ö–æ–ø–∏—Ä—É–µ–º .env —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä
echo "üöÄ –ö–æ–ø–∏—Ä—É–µ–º .env —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
scp -i "$SSH_KEY" \
    "$LOCAL_DIR/.env" \
    "$SERVER_USER@$SERVER_IP:~/$PROJECT_DIR/"

echo ""
echo "‚úÖ –§–∞–π–ª .env —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä!"
echo "üìÅ –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: ~/$PROJECT_DIR/.env"
echo ""

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
ssh -i "$SSH_KEY" "$SERVER_USER@$SERVER_IP" "
    cd $PROJECT_DIR
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –¥–ª—è docker compose
    if docker compose version &> /dev/null; then
        DOCKER_COMPOSE='docker compose'
    else
        DOCKER_COMPOSE='docker-compose'
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω—ã –ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
    if [ -f docker-compose.prod.yml ]; then
        echo 'üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã...'
        \$DOCKER_COMPOSE -f docker-compose.prod.yml down
        
        echo 'üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å –Ω–æ–≤—ã–º .env —Ñ–∞–π–ª–æ–º...'
        \$DOCKER_COMPOSE -f docker-compose.prod.yml up -d
        
        echo ''
        echo 'üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:'
        \$DOCKER_COMPOSE -f docker-compose.prod.yml ps
    else
        echo '‚ö†Ô∏è  docker-compose.prod.yml –Ω–µ –Ω–∞–π–¥–µ–Ω'
        echo 'üí° –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ –¥–µ–ø–ª–æ–π: ./scripts/deploy.sh'
    fi
"

echo ""
echo "üéâ –ì–æ—Ç–æ–≤–æ! Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã —Å –Ω–æ–≤—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è."
echo ""

