# Brama - LLM Processing Backend

**Brama** - ััะพ ะฐัะธะฝััะพะฝะฝัะน ัะตัะฒะธั ะพะฑัะฐะฑะพัะบะธ ะทะฐะฟัะพัะพะฒ ั ะฟะพะผะพััั LLM ะดะปั ED Analytics. ะะฝ ะพัะฒะตัะฐะตั ะทะฐ ะพะฑัะฐะฑะพัะบั ะทะฐะฟัะพัะพะฒ ะฟะพะปัะทะพะฒะฐัะตะปะตะน ะฒ ัะพะฝะพะฒะพะผ ัะตะถะธะผะต ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ ะพัะตัะตะดะธ ะทะฐะดะฐั Bull/Redis.

## ๐๏ธ ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโ         โโโโโโโโโโโโโโโโโโโโ         โโโโโโโโโโโโโโโโโโโ
โ   Backend   โ         โ      Redis       โ         โ     Brama       โ
โ  (ะฟะพัั 5000)โโโโโโโโโ>โ   (ะฟะพัั 6379)    โ<โโโโโโโโโ  (ะฟะพัั 5001)    โ
โโโโโโโโโโโโโโโ         โโโโโโโโโโโโโโโโโโโโ         โโโโโโโโโโโโโโโโโโโ
      โ                                                       โ
      โ                                                       โ
      โ  1. POST /api/process                                โ
      โ  { taskId, question, callbackUrl }                   โ
      โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ>โ
      โ                                                       โ
      โ                                            โโโโโโโโโโโโผโโโโโโโโโ
      โ                                            โ  Bull Queue       โ
      โ                                            โ  (task added)     โ
      โ                                            โโโโโโโโโโโโฌโโโโโโโโโ
      โ                                                       โ
      โ                                            โโโโโโโโโโโโผโโโโโโโโโ
      โ                                            โ  Worker Process   โ
      โ                                            โ  (processing...)  โ
      โ                                            โโโโโโโโโโโโฌโโโโโโโโโ
      โ                                                       โ
      โ  2. POST /api/callbacks/:taskId                      โ
      โ  { status: 'completed', result: {...} }              โ
      โ<โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
      โ                                                       โ
```

## ๐ฆ ะะพะผะฟะพะฝะตะฝัั

### 1. **Express Server** (`src/server.ts`)
- HTTP ัะตัะฒะตั ะฝะฐ ะฟะพััั 5001
- ะะฑัะฐะฑะพัะบะฐ ะฒัะพะดััะธั ะทะฐะฟัะพัะพะฒ ะพั Backend
- ะะฝัะตะณัะฐัะธั ั Bull Board UI (dev ัะตะถะธะผ)

### 2. **Queue Service** (`src/services/queueService.ts`)
- ะฃะฟัะฐะฒะปะตะฝะธะต ะพัะตัะตะดัั ะทะฐะดะฐั Bull
- ะะพะดะบะปััะตะฝะธะต ะบ Redis
- ะะพะฝะธัะพัะธะฝะณ ััะฐัะธััะธะบะธ ะพัะตัะตะดะธ

### 3. **Task Processor** (`src/workers/taskProcessor.ts`)
- Worker ะดะปั ะพะฑัะฐะฑะพัะบะธ ะทะฐะดะฐั ะธะท ะพัะตัะตะดะธ
- ะะฐัะฐะปะปะตะปัะฝะฐั ะพะฑัะฐะฑะพัะบะฐ (ะฟะพ ัะผะพะปัะฐะฝะธั 2 ะทะฐะดะฐัะธ)
- Mock ะทะฐะดะตัะถะบะฐ 15 ัะตะบัะฝะด (ะธะผะธัะฐัะธั LLM)
- ะัะฟัะฐะฒะบะฐ ัะตะทัะปััะฐัะพะฒ ัะตัะตะท callback

### 4. **API Routes** (`src/routes/process.ts`)
- `POST /api/process` - ะดะพะฑะฐะฒะปะตะฝะธะต ะทะฐะดะฐัะธ ะฒ ะพัะตัะตะดั
- ะะฐัะธัะฐ API ะบะปััะพะผ

### 5. **Middleware** (`src/middleware/apiKeyAuth.ts`)
- ะัะพะฒะตัะบะฐ API ะบะปััะฐ ะดะปั ะฒัะตั ะทะฐัะธัะตะฝะฝัั endpoints

### 6. **Query Agent** (`src/query-agent/`)
**ะะพะปั:** ะะฝะฐะปะธะท ะทะฐะฟัะพัะฐ ัะตัะตะท LangGraph workflow (4 ััะฐะฟะฐ)

- `index.ts` - ะะปะฐะฒะฝัะน ะบะปะฐัั QueryAgent
- `types.ts` - TypeScript ะธะฝัะตััะตะนัั
- `graph/` - LangGraph workflow
  - `graph.ts` - ะะฟัะตะดะตะปะตะฝะธะต ะณัะฐัะฐ
  - `state.ts` - QueryState ะธะฝัะตััะตะนั
  - `nodes/` - ะฃะทะปั ะณัะฐัะฐ
    - `selectStatformNode.ts` - ะญัะฐะฟ 1: ะัะฑะพั ััะฐััะพัะผั
    - `selectSectionNode.ts` - ะญัะฐะฟ 2: ะัะฑะพั ัะฐะทะดะตะปะฐ
    - `selectViewCellsNode.ts` - ะญัะฐะฟ 3: ะัะฑะพั ะฟัะตะดััะฐะฒะปะตะฝะธั ะธ ััะตะนะบะธ
    - `generateDashboardNode.ts` - ะญัะฐะฟ 4: ะะตะฝะตัะฐัะธั dashboard
- `prompts/` - LLM ะฟัะพะผะฟัั ะดะปั ะบะฐะถะดะพะณะพ ััะฐะฟะฐ
- `modules/` - ะัะฟะพะผะพะณะฐัะตะปัะฝัะต ะผะพะดัะปะธ
  - `statformList.ts` - ะะพะปััะตะฝะธะต ัะฟะธัะบะฐ ััะฐััะพัะผ
  - `sectionList.ts` - ะะพะปััะตะฝะธะต ัะฟะธัะบะฐ ัะฐะทะดะตะปะพะฒ
  - `viewList.ts` - ะะพะปััะตะฝะธะต ัะฟะธัะบะฐ ะฟัะตะดััะฐะฒะปะตะฝะธะน
  - `schemaBuilder.ts` - ะะพัััะพะตะฝะธะต ััะตะผั ัะฐะฑะปะธัั

### 7. **Dashboard Service** (`src/dashboard-service/`)
**ะะพะปั:** ะะตะฝะตัะฐัะธั ัะธะฝะฐะปัะฝะพะณะพ dashboard ั ะณัะฐัะธะบะฐะผะธ

- `index.ts` - ะญะบัะฟะพัั ะฟัะฑะปะธัะฝะพะณะพ API
- `dashboardGenerator.ts` - ะะปะฐะฒะฝัะน ะบะปะฐัั ะณะตะฝะตัะฐัะพัะฐ
- `cellExtractor.ts` - ะะทะฒะปะตัะตะฝะธะต ะทะฝะฐัะตะฝะธะน ััะตะตะบ ะธะท Neo4j
- `types.ts` - TypeScript ะธะฝัะตััะตะนัั
- `chartFormatters/` - ะคะพัะผะฐััะตัั ะณัะฐัะธะบะพะฒ
  - `linearChart.ts` - ะะธะฝะตะนะฝัะน ะณัะฐัะธะบ (ัะตะดะตัะฐะปัะฝัะต ะดะฐะฝะฝัะต)
  - `russiaMapChart.ts` - ะะฐััะฐ ะะพััะธะธ (ัะตะณะธะพะฝะฐะปัะฝัะต ะดะฐะฝะฝัะต)

### 8. **Shared Modules** (`src/shared/`)
**ะะพะปั:** ะะตัะตะธัะฟะพะปัะทัะตะผัะต ะบะปะธะตะฝัั ะธ ััะธะปะธัั

- `llmClient.ts` - LLM ะบะปะธะตะฝั (DeepSeek ัะตัะตะท AITunnel + OpenAI SDK)
- `neo4jClient.ts` - Neo4j ะบะปะธะตะฝั (Singleton ะฟะฐััะตัะฝ)
- `logger.ts` - ะกะธััะตะผะฐ ะปะพะณะธัะพะฒะฐะฝะธั ั ััะพะฒะฝัะผะธ (DEBUG/INFO/WARN/ERROR)

### 9. **Utilities** (`src/utils/`)
- `dashboardGenerator.ts` - ะขะพะฝะบะฐั ะพะฑะตััะบะฐ, ะดะตะปะตะณะธััะตั ะฒ QueryAgent
- `callbackSender.ts` - ะัะฟัะฐะฒะบะฐ ัะตะทัะปััะฐัะพะฒ ะฒ Backend

## ๐ ะะฐะฟััะบ

### Development ัะตะถะธะผ

```bash
# ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
cd brama
npm install

# ะะฐะฟััะบ ะฒ dev ัะตะถะธะผะต (ั hot reload)
npm run dev
```

### Production ัะตะถะธะผ

```bash
# ะกะฑะพัะบะฐ TypeScript
npm run build

# ะะฐะฟััะบ production
npm start
```

### Docker

```bash
# ะะท ะบะพัะฝะตะฒะพะน ะดะธัะตะบัะพัะธะธ ะฟัะพะตะบัะฐ
docker-compose up brama
```

## ๐ง ะะฐัััะพะนะบะฐ Environment Variables

### ๐ ะกะพะทะดะฐะฝะธะต .env ัะฐะนะปะฐ

ะัะต ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั ะฑะตััััั ะธะท ะบะพัะฝะตะฒะพะณะพ `.env.example` ัะฐะนะปะฐ ะฟัะพะตะบัะฐ.

**ะจะฐะณ 1:** ะกะบะพะฟะธััะนัะต `.env.example`
```bash
# ะ ะบะพัะฝะต ะฟัะพะตะบัะฐ
cp .env.example .env
```

**ะจะฐะณ 2:** ะะฑะฝะพะฒะธัะต ัะปะตะดัััะธะต ะฟะตัะตะผะตะฝะฝัะต ะฝะฐ **ัะตะฐะปัะฝัะต ะทะฝะฐัะตะฝะธั**:

```bash
# DeepSeek API (ัะตัะตะท AITunnel)
OPENAI_API_KEY=ะฒะฐั_ัะตะฐะปัะฝัะน_ะบะปัั_aitunnel
DEEPSEEK_MODEL=deepseek-chat

# Perplexity API (ะฒะตะฑ-ะฟะพะธัะบ)
PERPLEXITY_API_KEY=ะฒะฐั_ัะตะฐะปัะฝัะน_ะบะปัั_perplexity

# Neo4j Database
NEO4J_PASSWORD=ะฒะฐั_ัะตะฐะปัะฝัะน_ะฟะฐัะพะปั_neo4j

# API Keys (ะดะพะปะถะฝั ัะพะฒะฟะฐะดะฐัั ั backend/.env)
ALLOWED_API_KEY=ะฒะฐั_api_ะบะปัั
BACKEND_CORE_API_KEY=ะฒะฐั_api_ะบะปัั
```

**ะจะฐะณ 3:** ะััะฐะปัะฝัะต ะฟะตัะตะผะตะฝะฝัะต ะผะพะถะฝะพ ะพััะฐะฒะธัั ะฟะพ ัะผะพะปัะฐะฝะธั:

```bash
# Server
NODE_ENV=production
PORT=5001

# Redis
REDIS_HOST=redis
REDIS_PORT=6379

# Backend
BACKEND_URL=http://backend:5000

# Worker
WORKER_CONCURRENCY=2

# Data
DEFAULT_YEAR=2024
```

### ๐ ะะดะต ะฟะพะปััะธัั API ะบะปััะธ

#### 1. AITunnel API (DeepSeek)

**ะจะฐะณะธ:**
1. ะะตัะตะนะดะธัะต ะฝะฐ https://aitunnel.ru
2. ะะฐัะตะณะธัััะธััะนัะตัั ะธะปะธ ะฒะพะนะดะธัะต
3. ะะตัะตะนะดะธัะต ะฒ ัะฐะทะดะตะป **API Keys**
4. ะกะพะทะดะฐะนัะต ะฝะพะฒัะน ะบะปัั
5. ะกะบะพะฟะธััะนัะต ะบะปัั (ะฝะฐัะธะฝะฐะตััั ั `sk-aitunnel-...`)

**ะกัะพะธะผะพััั:**
- DeepSeek v3.2: ะะดะธะฝ ะธะท ัะฐะผัั ะดะตัะตะฒัั LLM ะฝะฐ ััะฝะบะต
- ะะดะธะฝ ะทะฐะฟัะพั ะฟะพะปัะทะพะฒะฐัะตะปั โ $0.001-0.002 (ะทะฝะฐัะธัะตะปัะฝะพ ะดะตัะตะฒะปะต Claude)

#### 2. Perplexity API (ะฒะตะฑ-ะฟะพะธัะบ)

**ะจะฐะณะธ:**
1. ะะตัะตะนะดะธัะต ะฝะฐ https://www.perplexity.ai/settings/api
2. ะะพะนะดะธัะต ะธะปะธ ะทะฐัะตะณะธัััะธััะนัะตัั
3. ะะตัะตะนะดะธัะต ะฒ ัะฐะทะดะตะป **API**
4. ะกะพะทะดะฐะนัะต ะฝะพะฒัะน API ะบะปัั
5. ะกะบะพะฟะธััะนัะต ะบะปัั (ะฝะฐัะธะฝะฐะตััั ั `pplx-...`)

**ะกัะพะธะผะพััั:**
- sonar (ะฑัััััะน ะฟะพะธัะบ): ~$0.005 ะทะฐ ะทะฐะฟัะพั
- sonar-deep-research (ะณะปัะฑะพะบะธะน ะฟะพะธัะบ): ~$0.05 ะทะฐ ะทะฐะฟัะพั

**ะัะฟะพะปัะทะพะฒะฐะฝะธะต:**
- ะะตะฑ-ะฟะพะธัะบ ะฒัะฟะพะปะฝัะตััั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะดะปั ะบะฐะถะดะพะณะพ ะทะฐะฟัะพัะฐ ะฟะพะปัะทะพะฒะฐัะตะปั
- LLM ัะตัะฐะตั ะธัะฟะพะปัะทะพะฒะฐัั ะฑัััััะน ะธะปะธ ะณะปัะฑะพะบะธะน ะฟะพะธัะบ ะฝะฐ ะพัะฝะพะฒะต ะบะฐัะตััะฒะฐ ะดะฐะฝะฝัั ะฒ ะะ

#### 3. Neo4j Password

ะกะณะตะฝะตัะธััะนัะต ะฝะฐะดะตะถะฝัะน ะฟะฐัะพะปั:

```bash
openssl rand -base64 24
```

#### 3. Backend API Key

ะกะณะตะฝะตัะธััะนัะต ัะปััะฐะนะฝัะน ัะตะบัะตัะฝัะน ะบะปัั:

```bash
openssl rand -hex 32
```

**โ๏ธ ะะฐะถะฝะพ:** ะัะฟะพะปัะทัะนัะต **ะพะดะธะฝ ะธ ัะพั ะถะต** ะบะปัั ะดะปั `ALLOWED_API_KEY` ะธ `BACKEND_CORE_API_KEY`

### ๐ ะัะธะผะตะฝะตะฝะธะต ะธะทะผะตะฝะตะฝะธะน

ะะพัะปะต ะธะทะผะตะฝะตะฝะธั `.env` ัะฐะนะปะฐ ะฟะตัะตะทะฐะฟัััะธัะต ัะตัะฒะธั:

```bash
# ะะฐัะธะฐะฝั 1: ะัััััะน ะฟะตัะตะทะฐะฟััะบ
docker-compose restart brama

# ะะฐัะธะฐะฝั 2: ะะพะปะฝะฐั ะฟะตัะตัะฑะพัะบะฐ
docker-compose down
docker-compose up -d --build brama
```

### โ ะัะพะฒะตัะบะฐ ะฝะฐัััะพะนะบะธ

**1. ะัะพะฒะตัััะต ะทะฐะฟััะบ ัะตัะฒะธัะฐ:**

```bash
docker logs ed_analytics_brama_dev
```

ะะพะปะถะฝั ัะฒะธะดะตัั:
```
๐ค ะะฝะธัะธะฐะปะธะทะฐัะธั LLM ะธ Neo4j ัะตัะฒะธัะพะฒ...
[LLMService] ะะฝะธัะธะฐะปะธะทะธัะพะฒะฐะฝ (ะผะพะดะตะปั: deepseek-chat, ะณะพะด: 2024)
[LLMService] DeepSeek API ัะตัะตะท AITunnel ะฟัะพะบัะธ
[Neo4jService] ะะพะดะบะปััะตะฝะธะต ะบ Neo4j: bolt://localhost:7687
โ ะกะตัะฒะธัั ะธะฝะธัะธะฐะปะธะทะธัะพะฒะฐะฝั ััะฟะตัะฝะพ
๐ Brama Backend is running
```

**2. ะัะพะฒะตัััะต health endpoint:**

```bash
curl http://localhost:5001/health
```

**3. ะัะพะฒะตัััะต ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั:**

```bash
docker exec ed_analytics_brama_dev env | grep -E "OPENAI|DEEPSEEK|NEO4J"
```

**4. ะัะพะฒะตัััะต ะปะพะณะธัะพะฒะฐะฝะธะต LLM ะทะฐะฟัะพัะพะฒ:**

```bash
# ะกะฟะธัะพะบ ะปะพะณะพะฒ
docker exec ed_analytics_brama_dev ls -la /app/logs/llm/

# ะะพัะปะตะดะฝะธะน ะปะพะณ
docker exec ed_analytics_brama_dev ls -lt /app/logs/llm/ | head -2
```

### ๐ ะะพะบะฐะปัะฝะพะต ะปะพะณะธัะพะฒะฐะฝะธะต LLM ะทะฐะฟัะพัะพะฒ

ะัะต ะทะฐะฟัะพัั ะบ DeepSeek API ะฐะฒัะพะผะฐัะธัะตัะบะธ ะปะพะณะธัััััั ะฒ JSON ัะฐะนะปั.

**ะะฐัะฟะพะปะพะถะตะฝะธะต:** `brama/logs/llm/`

**ะคะพัะผะฐั ัะฐะนะปะฐ:** `query_[timestamp]_[id].json`

**ะัะธะผะตั ะปะพะณะฐ:**
```json
{
  "queryId": "query_1234567890_abc123",
  "question": "ะกะบะพะปัะบะพ ัะบะพะปัะฝะธะบะพะฒ ะฒ ะฒะพะปะณะพะณัะฐะดะต",
  "timestamp": "2024-11-05T10:30:00.000Z",
  "steps": [
    {
      "step": 1,
      "stepName": "ะจะฐะณ 1: form_code + view_type",
      "prompt": "ะขั โ ะฐััะธััะตะฝั ะดะปั ัะฐะฑะพัั...",
      "response": "{\"form_code\": \"OO_1\"}",
      "inputTokens": 150,
      "outputTokens": 25,
      "durationMs": 1200,
      "cost": 0.00082
    }
  ],
  "totalTokens": 650,
  "totalCost": 0.00428,
  "totalDurationMs": 4500
}
```

**ะะพะปะตะทะฝัะต ะบะพะผะฐะฝะดั:**

```bash
# ะะพะปะธัะตััะฒะพ ะปะพะณะพะฒ
docker exec ed_analytics_brama_dev find /app/logs/llm/ -name "*.json" | wc -l

# ะกัะผะผะฐัะฝะฐั ััะพะธะผะพััั
docker exec ed_analytics_brama_dev cat /app/logs/llm/*.json | grep totalCost | awk '{sum+=$2} END {print "Total: $" sum}'
```

### ๐ ะะตะทะพะฟะฐัะฝะพััั

โ๏ธ **ะะะะะ:**
- โ ะะ ะบะพะผะผะธัััะต `.env` ัะฐะนะป ะฒ Git
- โ ะะ ััะฐะฝะธัะต API ะบะปััะธ ะฒ ะพัะบัััะพะผ ะฒะธะดะต
- โ ะัะฟะพะปัะทัะนัะต ัะฐะทะฝัะต ะบะปััะธ ะดะปั dev/prod ะพะบััะถะตะฝะธะน
- โ ะะตะณัะปััะฝะพ ัะพัะธััะนัะต API ะบะปััะธ

## ๐ Bull Board UI

ะ **development** ัะตะถะธะผะต ะดะพัััะฟะตะฝ ะฒะตะฑ-ะธะฝัะตััะตะนั ะดะปั ะผะพะฝะธัะพัะธะฝะณะฐ ะพัะตัะตะดะธ:

**URL:** `http://localhost:5001/admin/queues`

### ะะพะทะผะพะถะฝะพััะธ:
- โ ะัะพัะผะพัั ะฐะบัะธะฒะฝัั ะทะฐะดะฐั
- โ ะัะพัะผะพัั ะทะฐะฒะตััะตะฝะฝัั ะทะฐะดะฐั
- โ ะัะพัะผะพัั failed ะทะฐะดะฐั
- โ Retry failed ะทะฐะดะฐั
- โ ะัะธััะบะฐ ะพัะตัะตะดะธ
- โ ะกัะฐัะธััะธะบะฐ ะพะฑัะฐะฑะพัะบะธ

## ๐ API Endpoints

### POST `/api/process`

ะะพะฑะฐะฒะปะตะฝะธะต ะทะฐะดะฐัะธ ะฒ ะพัะตัะตะดั ะพะฑัะฐะฑะพัะบะธ.

**ะขัะตะฑะพะฒะฐะฝะธั:** API ะบะปัั ะฒ ะทะฐะณะพะปะพะฒะบะต `X-API-Key`

**Request:**
```json
{
  "taskId": "uuid-task-id",
  "question": "ะะพะฟัะพั ะฟะพะปัะทะพะฒะฐัะตะปั",
  "callbackUrl": "http://backend:5000/api/callbacks/:taskId"
}
```

**Response:**
```json
{
  "success": true,
  "taskId": "uuid-task-id",
  "message": "Task added to queue"
}
```

### GET `/health`

ะัะพะฒะตัะบะฐ ะทะดะพัะพะฒัั ัะตัะฒะธัะฐ.

**Response:**
```json
{
  "status": "OK",
  "timestamp": "2025-11-04T12:00:00.000Z",
  "environment": "development",
  "queue": {
    "waiting": 0,
    "active": 1,
    "completed": 15,
    "failed": 0
  }
}
```

## ๐ Workflow ะพะฑัะฐะฑะพัะบะธ ะทะฐะดะฐัะธ

1. **Backend ะพัะฟัะฐะฒะปัะตั ะทะฐะดะฐัั** โ `POST /api/process`
2. **Brama ะดะพะฑะฐะฒะปัะตั ะฒ ะพัะตัะตะดั** โ Bull Queue
3. **Worker ะฑะตัะตั ะทะฐะดะฐัั** โ ะะฐัะธะฝะฐะตั ะพะฑัะฐะฑะพัะบั
4. **DashboardGenerator ะดะตะปะตะณะธััะตั** โ QueryAgent.processQuery(question)
5. **LangGraph Workflow (4 ััะฐะฟะฐ)**:
   - **ะญัะฐะฟ 1:** ะัะฑะพั ะกะขะะขะคะะะะซ ัะตัะตะท LLM
   - **ะญัะฐะฟ 2:** ะัะฑะพั ะะะะะะะ ัะตัะตะท LLM
   - **ะญัะฐะฟ 3:** ะัะฑะพั ะะะะะกะขะะะะะะะฏ ะธ ะฏะงะะะะ ัะตัะตะท LLM
   - **ะญัะฐะฟ 4:** ะะตะฝะตัะฐัะธั dashboard (DashboardService)
6. **DashboardService** โ ะะทะฒะปะตัะตะฝะธะต ะดะฐะฝะฝัั ะธะท Neo4j + ัะพัะผะฐัะธัะพะฒะฐะฝะธะต ะณัะฐัะธะบะพะฒ
7. **ะัะฟัะฐะฒะบะฐ ัะตะทัะปััะฐัะฐ** โ `POST {callbackUrl}`
8. **Backend ัะพััะฐะฝัะตั ัะตะทัะปััะฐั** โ ะะ ะพะฑะฝะพะฒะปัะตััั
9. **ะฃะฒะตะดะพะผะปะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั** โ Telegram ะฑะพั

## ๐๏ธ ะะฐะทัะฐะฑะพัะบะฐ

### ะกัััะบัััะฐ ะฟัะพะตะบัะฐ

```
brama/
โโโ src/
โ   โโโ server.ts                      # ะัะฝะพะฒะฝะพะน Express ัะตัะฒะตั
โ   โ
โ   โโโ routes/
โ   โ   โโโ process.ts                 # POST /api/process
โ   โ
โ   โโโ middleware/
โ   โ   โโโ apiKeyAuth.ts              # ะัะพะฒะตัะบะฐ API ะบะปััะฐ
โ   โ
โ   โโโ services/
โ   โ   โโโ queueService.ts            # Bull Queue setup
โ   โ
โ   โโโ workers/
โ   โ   โโโ taskProcessor.ts           # Worker ะพะฑัะฐะฑะพัะบะธ ะทะฐะดะฐั
โ   โ
โ   โโโ query-agent/                   # ๐ค ะะฝะฐะปะธะท ะทะฐะฟัะพัะฐ (LangGraph)
โ   โ   โโโ index.ts                   # QueryAgent ะบะปะฐัั
โ   โ   โโโ types.ts                   # TypeScript ะธะฝัะตััะตะนัั
โ   โ   โโโ graph/
โ   โ   โ   โโโ graph.ts               # LangGraph workflow
โ   โ   โ   โโโ state.ts               # QueryState
โ   โ   โ   โโโ nodes/
โ   โ   โ       โโโ selectStatformNode.ts
โ   โ   โ       โโโ selectSectionNode.ts
โ   โ   โ       โโโ selectViewCellsNode.ts
โ   โ   โ       โโโ generateDashboardNode.ts
โ   โ   โโโ prompts/                   # LLM ะฟัะพะผะฟัั
โ   โ   โ   โโโ statformSelection.ts
โ   โ   โ   โโโ sectionSelection.ts
โ   โ   โ   โโโ viewCellSelection.ts
โ   โ   โโโ modules/                   # ะัะฟะพะผะพะณะฐัะตะปัะฝัะต ะผะพะดัะปะธ
โ   โ       โโโ statformList.ts
โ   โ       โโโ sectionList.ts
โ   โ       โโโ viewList.ts
โ   โ       โโโ schemaBuilder.ts
โ   โ
โ   โโโ dashboard-service/             # ๐ ะะตะฝะตัะฐัะธั dashboard
โ   โ   โโโ index.ts
โ   โ   โโโ dashboardGenerator.ts
โ   โ   โโโ cellExtractor.ts
โ   โ   โโโ types.ts
โ   โ   โโโ chartFormatters/
โ   โ       โโโ linearChart.ts
โ   โ       โโโ russiaMapChart.ts
โ   โ
โ   โโโ shared/                        # ๐ง ะะฑัะธะต ะผะพะดัะปะธ
โ   โ   โโโ llmClient.ts               # LLM ะบะปะธะตะฝั (DeepSeek)
โ   โ   โโโ neo4jClient.ts             # Neo4j ะบะปะธะตะฝั (Singleton)
โ   โ   โโโ logger.ts                  # ะกะธััะตะผะฐ ะปะพะณะธัะพะฒะฐะฝะธั
โ   โ
โ   โโโ utils/
โ   โ   โโโ dashboardGenerator.ts      # ะะฑะตััะบะฐ ะฝะฐะด QueryAgent
โ   โ   โโโ callbackSender.ts          # ะัะฟัะฐะฒะบะฐ callbacks
โ   โ
โ   โโโ types/
โ       โโโ index.ts                   # ะะฑัะธะต TypeScript ัะธะฟั
โ
โโโ data/
โ   โโโ regions.json                   # ะะฐะฝะฝัะต ัะตะณะธะพะฝะพะฒ ะะพััะธะธ
โ   โโโ ะกะฟะธัะพะบ_ัะฐะฑะปะธั_ะะ_1.csv        # ะกะฟะธัะพะบ ัะฐะฑะปะธั ััะฐััะพัะผั ะะ_1
โ   โโโ ะกะฟะธัะพะบ_ัะฐะฑะปะธั_ะะ_2.csv        # ะกะฟะธัะพะบ ัะฐะฑะปะธั ััะฐััะพัะผั ะะ_2
โ
โโโ logs/llm/                          # ะะพะณะธ LLM ะทะฐะฟัะพัะพะฒ (ะฐะฒัะพ-ัะพะทะดะฐะตััั)
โ
โโโ package.json
โโโ tsconfig.json
โโโ Dockerfile
โโโ README.md
```

### LLM ะะฝัะตะณัะฐัะธั

Brama ะฟะพัััะพะตะฝ ะฝะฐ **LangGraph** ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ **DeepSeek API** ัะตัะตะท AITunnel ะฟัะพะบัะธ.

**ะััะธัะตะบัััะฐ:**

- **LangGraph** (@langchain/langgraph) - ััะตะนะผะฒะพัะบ ะดะปั ะฟะพัััะพะตะฝะธั stateful workflows
- **QueryAgent** - ะณะปะฐะฒะฝัะน ะบะปะฐัั, ัะฟัะฐะฒะปัััะธะน 4-ััะฐะฟะฝัะผ workflow
- **LLMClient** (shared) - ะบะปะธะตะฝั ะดะปั ัะฐะฑะพัั ั DeepSeek ัะตัะตะท OpenAI SDK
- **LangSmith** (ะพะฟัะธะพะฝะฐะปัะฝะพ) - ััะฐััะธัะพะฒะบะฐ ะธ ะผะพะฝะธัะพัะธะฝะณ LLM ะฒัะทะพะฒะพะฒ

**ะัะฟะพะปัะทัะตะผะฐั ะผะพะดะตะปั:** `deepseek-chat` (DeepSeek v3.2)

**Workflow ะพะฑัะฐะฑะพัะบะธ:**
1. **ะญัะฐะฟ 1:** LLM ะฒัะฑะธัะฐะตั ััะฐััะพัะผั ะธะท ัะฟะธัะบะฐ
2. **ะญัะฐะฟ 2:** LLM ะฒัะฑะธัะฐะตั ัะฐะทะดะตะป
3. **ะญัะฐะฟ 3:** LLM ะฒัะฑะธัะฐะตั ะฟัะตะดััะฐะฒะปะตะฝะธะต ะธ ััะตะนะบั ะฒ ัะฐะฑะปะธัะต
4. **ะญัะฐะฟ 4:** DashboardService ะณะตะฝะตัะธััะตั ัะธะฝะฐะปัะฝัะน dashboard

**LangSmith ััะฐััะธัะพะฒะบะฐ:**
- ะะบะปััะฐะตััั ัะตัะตะท ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั `LANGSMITH_*`
- ะะพะบะฐะทัะฒะฐะตั ะดะตัะฐะปะธ ะบะฐะถะดะพะณะพ ััะฐะฟะฐ LangGraph
- ะะพะปะตะทะฝะพ ะดะปั ะพัะปะฐะดะบะธ ะธ ะฐะฝะฐะปะธะทะฐ ะฟัะพะผะฟัะพะฒ

**ะคะฐะนะปั:**
- `src/query-agent/` - LangGraph workflow (4 ัะทะปะฐ)
- `src/shared/llmClient.ts` - LLM ะบะปะธะตะฝั (DeepSeek ัะตัะตะท AITunnel)
- `src/query-agent/prompts/` - ะัะพะผะฟัั ะดะปั ะบะฐะถะดะพะณะพ ััะฐะฟะฐ

## ๐ ะะพะฝะธัะพัะธะฝะณ

### ะะพะณะธ

Brama ะฒัะฒะพะดะธั ะฟะพะดัะพะฑะฝัะต ะปะพะณะธ ะดะปั ะพัะปะฐะดะบะธ:

```
[Queue] Adding task abc-123 to queue
[Worker] Processing task abc-123
[Worker] Question: ะกะบะพะปัะบะพ ัะบะพะปัะฝะธะบะพะฒ ะฒ ะะพะปะณะพะณัะฐะดะต?
[LLMService] ะจะฐะณ 1: ะะฟัะตะดะตะปะตะฝะธะต form_code ะธ view_type
[LLMService] ะัะฒะตั DeepSeek: {"form_code": "OO_1", "view_type": "ะณะพั_ะณะพัะพะด"}
[Neo4jService] Executing Cypher query...
[LLMLogger] ะกะพััะฐะฝะตะฝะธะต ะปะพะณะฐ ะฒ logs/llm/query_abc123.json
[Worker] Generating dashboard for task abc-123
[Worker] Sending success result for task abc-123
[Callback] Success: 200 OK
[Worker] Task abc-123 completed successfully
```

### ะกัะฐัะธััะธะบะฐ ะพัะตัะตะดะธ

ะงะตัะตะท `/health` endpoint ะธะปะธ Bull Board UI:
- ะะพะปะธัะตััะฒะพ ะทะฐะดะฐั ะฒ ะพะถะธะดะฐะฝะธะธ
- ะะบัะธะฒะฝัะต ะทะฐะดะฐัะธ
- ะะฐะฒะตััะตะฝะฝัะต ะทะฐะดะฐัะธ
- Failed ะทะฐะดะฐัะธ

## ๐ง Troubleshooting

### ะัะพะฑะปะตะผะฐ: ะะฐะดะฐัะธ ะฝะต ะพะฑัะฐะฑะฐััะฒะฐัััั

**ะะตัะตะฝะธะต:**
1. ะัะพะฒะตัััะต ะฟะพะดะบะปััะตะฝะธะต ะบ Redis: `redis-cli ping`
2. ะัะพะฒะตัััะต ะปะพะณะธ Brama: `docker-compose logs brama`
3. ะัะบัะพะนัะต Bull Board: `http://localhost:5001/admin/queues`

### ะัะพะฑะปะตะผะฐ: Callback ะฝะต ะดะพัะพะดะธั ะดะพ Backend

**ะะตัะตะฝะธะต:**
1. ะัะพะฒะตัััะต `BACKEND_URL` ะฒ env
2. ะัะพะฒะตัััะต API ะบะปัั (`ALLOWED_API_KEY`)
3. ะัะพะฒะตัััะต ัะตัะตะฒะพะต ะฟะพะดะบะปััะตะฝะธะต ะผะตะถะดั ะบะพะฝัะตะนะฝะตัะฐะผะธ

### ะัะพะฑะปะตะผะฐ: ะัะตัะตะดั ะฟะตัะตะฟะพะปะฝะตะฝะฐ

**ะะตัะตะฝะธะต:**
1. ะฃะฒะตะปะธัััะต `WORKER_CONCURRENCY` (ะฟะพ ัะผะพะปัะฐะฝะธั 2)
2. ะัะพะฒะตัััะต ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััั LLM ะทะฐะฟัะพัะพะฒ ะฒ ะปะพะณะฐั
3. ะัะธััะธัะต failed ะทะฐะดะฐัะธ ัะตัะตะท Bull Board
4. ะะฐััะผะพััะธัะต ะฒะพะทะผะพะถะฝะพััั ะบััะธัะพะฒะฐะฝะธั ัะฐัััั ะทะฐะฟัะพัะพะฒ

### ะัะพะฑะปะตะผะฐ: ะัะธะฑะบะธ ะฒ LangGraph workflow

**ะะตัะตะฝะธะต:**
1. ะัะพะฒะตัััะต ะปะพะณะธ ะฒ ะบะพะฝัะพะปะธ - ะบะฐะถะดัะน ััะฐะฟ ะปะพะณะธััะตััั
2. ะะบะปััะธัะต LangSmith ััะฐััะธัะพะฒะบั ะดะปั ะดะตัะฐะปัะฝะพะณะพ ะฟัะพัะผะพััะฐ
3. ะัะพะฒะตัััะต ััะพ ะฒัะต 4 ัะทะปะฐ ะบะพััะตะบัะฝะพ ะธะฝะธัะธะฐะปะธะทะธัะพะฒะฐะฝั
4. ะฃะฑะตะดะธัะตัั ััะพ State ะฟะตัะตะดะฐะตััั ะผะตะถะดั ัะทะปะฐะผะธ

### ะัะพะฑะปะตะผะฐ: ะัะธะฑะบะธ ะฟัะธ ะพะฑัะฐัะตะฝะธะธ ะบ DeepSeek API

**ะะตัะตะฝะธะต:**
1. ะัะพะฒะตัััะต ะฒะฐะปะธะดะฝะพััั `OPENAI_API_KEY` (AITunnel ะบะปัั)
2. ะัะพะฒะตัััะต ะฑะฐะปะฐะฝั ะฐะบะบะฐัะฝัะฐ AITunnel ะฝะฐ https://aitunnel.ru
3. ะัะพะฒะตัััะต ะดะพัััะฟะฝะพััั API: https://api.aitunnel.ru/v1/
4. ะัะพะฒะตัััะต ััะพะฒะตะฝั ะปะพะณะธัะพะฒะฐะฝะธั: `LOG_LEVEL=DEBUG`

### ะัะพะฑะปะตะผะฐ: ะัะธะฑะบะธ ะฟะพะดะบะปััะตะฝะธั ะบ Neo4j

**ะะตัะตะฝะธะต:**
1. ะัะพะฒะตัััะต ััะพ Neo4j ะบะพะฝัะตะนะฝะตั ะทะฐะฟััะตะฝ: `docker ps | grep neo4j`
2. ะัะพะฒะตัััะต `NEO4J_URI` ะธ `NEO4J_PASSWORD` ะฒ `.env`
3. ะัะพะฒะตัััะต ะปะพะณะธ Neo4j: `docker logs <neo4j_container>`
4. ะฃะฑะตะดะธัะตัั ััะพ ะฑะฐะทะฐ ะดะฐะฝะฝัั ะฒะพัััะฐะฝะพะฒะปะตะฝะฐ ะธะท ะดะฐะผะฟะฐ
5. ะัะพะฒะตัััะต ััะพ Neo4jClient ะบะพััะตะบัะฝะพ ะธะฝะธัะธะฐะปะธะทะธัะพะฒะฐะฝ (Singleton)

### ะัะพะฑะปะตะผะฐ: QueryAgent ะฝะต ะธะฝะธัะธะฐะปะธะทะธัะพะฒะฐะฝ

**ะะตัะตะฝะธะต:**
1. ะัะพะฒะตัััะต ััะพ `DashboardGenerator.initialize()` ะฒัะทัะฒะฐะตััั ะฟัะธ ััะฐััะต
2. ะัะพะฒะตัััะต ะปะพะณะธ: ะดะพะปะถะฝะพ ะฑััั ัะพะพะฑัะตะฝะธะต "QueryAgent initialized"
3. ะฃะฑะตะดะธัะตัั ััะพ ะฒัะต ะทะฐะฒะธัะธะผะพััะธ ัััะฐะฝะพะฒะปะตะฝั: `npm install`
4. ะัะพะฒะตัััะต ะฒะตััะธะธ ะฟะฐะบะตัะพะฒ LangGraph: `npm list @langchain/langgraph`



