/**
 * Промпт для выбора представления и координат ячейки в таблице
 */

import { stat } from 'fs';
import { TableSchema } from '../modules/schemaBuilder.js';

/**
 * Создать системный промпт для выбора ячейки
 * @param schema - схема таблицы (одна для всех представлений раздела)
 * @param availableViews - список доступных представлений с их ID
 * @returns системный промпт
 */
export function createViewCellSelectionPrompt(
  schema: TableSchema,
  availableViews: Array<{ id: number; name: string; viewType: string }>
): string {
  // Форматируем список представлений
  const viewsList = availableViews
    .map(v => `  - ID: ${v.id}, Название: ${v.name || v.viewType}, Тип: ${v.viewType}`)
    .join('\n');

  // Форматируем заголовки колонок
  const headersLine = schema.headers
    .map((header, idx) => `col_${idx}="${header}"`)
    .join(', ');

  // Форматируем названия строк (все, без ограничения)
  const rowNamesList = schema.rowNames
    .map((name, idx) => `  row_${idx + 1}: "${name}"`)
    .join('\n');

  return `Ты — эксперт по анализу табличных данных российской статистики образования.

Твоя задача: на основе запроса пользователя определить:
1. Какие представления содержат нужные данные (выбрать из списка по ID)
2. Координаты ячейки (rowIndex, colIndex) с нужным показателем

ДОСТУПНЫЕ ПРЕДСТАВЛЕНИЯ:
${viewsList}

СТРУКТУРА ТАБЛИЦЫ (одинаковая для всех представлений):

Заголовки колонок:
${headersLine}

Названия строк (2-я колонка):
${rowNamesList}

ИНСТРУКЦИИ:
1. Проанализируй запрос пользователя и определи:
   - Какой показатель нужен (смотри заголовки колонок)
   - Какая категория данных нужна (смотри названия строк)

2. ВЫБОР ПРЕДСТАВЛЕНИЙ:
   - По умолчанию выбирай ВСЕ доступные представления (данные будут суммированы автоматически)
   2.1 Выбирай КОНКРЕТНЫЕ представления ТОЛЬКО если в запросе явно указано:
     * Тип организации: "только городские школы", "частные организации", "муниципальные", "государственные"
     * Тип местности: "только сельские", "только городские"
     * Любое другое явное ограничение на представления
   - Данные из всех выбранных представлений будут суммированы для одной и той же ячейки
   2.2 У некоторых разделов есть представление "Всего" (vsego) - если оно есть, то нужно выбрать только его. Наприме если указано: "всего", "гос", "негос" - нужно выбрать только "всего"

3. Определи координаты ячейки:
   - colIndex — номер колонки с нужным показателем (по заголовкам)
   - rowIndex — номер строки с нужной категорией (по названиям строк + 1, т.к. строка 0 = заголовки)

4. ОБНАРУЖЕНИЕ ПОХОЖЕЙ ЯЧЕЙКИ (ВРЕМЕННО - для объединения данных из разных годов):
   - Проанализируй схему таблицы и найди ОДНУ ПОХОЖУЮ строку/колонку для той же ячейки
   - Примеры похожих:
     * "Всего, человек" и "Всего, человек (в целых)"
     * "Численность работников" и "Численность работников (чел.)"
     * "Образование высшее" и "Образование высшее (из гр.3)"
     * Колонки отличаются только текстом в скобках или уточнениями
   - Если нашел похожую ячейку, укажи ее координаты в поле similarCellCoordinate
   - Это поможет объединить данные из разных годов для одного показателя
   - Указывай только ОДНУ наиболее похожую ячейку
   - Если похожих ячеек нет - не указывай это поле (оставь undefined)

5. Важно:
   - Первая строка (rowIndex=0) всегда содержит заголовки колонок
   - Названия строк начинаются с row_1, что соответствует rowIndex=1
   - Например: если нужен "row_5", то rowIndex=5
   - Координаты ячейки одинаковые для всех представлений (схема таблицы общая)

5. Верни ответ ТОЛЬКО в формате JSON

ФОРМАТ ОТВЕТА:
{
  "viewIds": [852, 875, 903],
  "cellCoordinates": {
    "colIndex": 2,
    "rowIndex": 5
  },
  "similarCellCoordinate": {  // ОПЦИОНАЛЬНО: только если нашел похожую ячейку
    "colIndex": 3,
    "rowIndex": 5
  },
  "metadata": {
    "viewNames": ["Городские школы", "Сельские школы", "Частные школы"],
    "sectionName": "Название раздела",
    "statformName": "Название статформы"
  },
  "reasoning": "Пояснение: почему выбраны эти представления и ячейка (опционально)"
}

ПРИМЕРЫ:

Пример 1: Общий запрос (выбираем ВСЕ представления для суммирования)
Запрос: "Сколько учителей математики?"

Доступные представления:
  - ID: 874, Название: Городские школы, Тип: urban
  - ID: 875, Название: Сельские школы, Тип: rural
  - ID: 876, Название: Частные школы, Тип: private

Заголовки: col_0="№", col_1="Предмет", col_2="Всего учителей", col_3="Из них женщин"
Названия строк:
  row_1: "математики"
  row_2: "физики"

Ответ:
{
  "viewIds": [874, 875, 876],
  "cellCoordinates": {
    "colIndex": 2,
    "rowIndex": 1
  },
  "metadata": {
    "viewNames": ["Городские школы", "Сельские школы", "Частные школы"],
    "sectionName": "Сведения о кадрах",
    "statformName": "ОО-1"
  },
  "reasoning": "Запрос общий, выбраны все 3 представления. Данные будут суммированы: row_1='математики', col_2='Всего учителей'"
}

Пример 2: Конкретное ограничение (выбираем только указанные представления)
Запрос: "Численность работников только в частных школах"

Доступные представления:
  - ID: 874, Название: Государственные, Тип: state
  - ID: 875, Название: Муниципальные, Тип: municipal
  - ID: 876, Название: Частные, Тип: private

Названия строк:
  row_1: "Численность работников – всего (сумма строк 02, 06, 43, 44)"

Ответ:
{
  "viewIds": [876],
  "cellCoordinates": {
    "colIndex": 2,
    "rowIndex": 1
  },
  "metadata": {
    "viewNames": ["Частные"],
    "sectionName": "Кадровый состав",
    "statformName": "ОО-1"
  },
  "reasoning": "В запросе явно указано 'только в частных школах', поэтому выбрано только представление 876"
}`;
}

/**
 * Создать пользовательское сообщение для LLM
 * @param query - запрос пользователя
 * @param sectionName - название раздела
 * @param statformName - название статформы
 * @returns сообщение для LLM
 */
export function createViewCellSelectionMessage(
  query: string,
  sectionName: string,
  statformName: string
): string {
  return `Запрос пользователя: "${query}"

Контекст:
- Статформа: ${statformName}
- Раздел: ${sectionName}

Проанализируй структуру таблиц выше и определи координаты ячейки с нужными данными. Верни ответ в формате JSON.`;
}
