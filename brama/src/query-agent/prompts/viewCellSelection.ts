/**
 * Промпт для выбора представления и координат ячейки в таблице
 */

import { TableSchema } from '../modules/schemaBuilder.js';

/**
 * Создать системный промпт для выбора ячейки
 * @param schema - схема таблицы (одна для всех представлений раздела)
 * @param availableViews - список доступных представлений с их ID
 * @returns системный промпт
 */
export function createViewCellSelectionPrompt(
  schema: TableSchema,
  availableViews: Array<{ id: number; name: string; viewType: string }>
): string {
  // Форматируем список представлений
  const viewsList = availableViews
    .map(v => `  - ID: ${v.id}, Название: ${v.name || v.viewType}, Тип: ${v.viewType}`)
    .join('\n');

  // Форматируем заголовки колонок
  const headersLine = schema.headers
    .map((header, idx) => `col_${idx}="${header}"`)
    .join(', ');

  // Форматируем названия строк (все, без ограничения)
  const rowNamesList = schema.rowNames
    .map((name, idx) => `  row_${idx + 1}: "${name}"`)
    .join('\n');

  return `Ты — эксперт по анализу табличных данных российской статистики образования.

Твоя задача: на основе запроса пользователя определить:
1. Какое представление содержит нужные данные (выбрать из списка по ID)
2. Координаты ячейки (rowIndex, colIndex) с нужным показателем

ДОСТУПНЫЕ ПРЕДСТАВЛЕНИЯ:
${viewsList}

СТРУКТУРА ТАБЛИЦЫ (одинаковая для всех представлений):

Заголовки колонок:
${headersLine}

Названия строк (2-я колонка):
${rowNamesList}

ИНСТРУКЦИИ:
1. Проанализируй запрос пользователя и определи:
   - Какой показатель нужен (смотри заголовки колонок)
   - Какая категория данных нужна (смотри названия строк)
2. Выбери представление из списка доступных (по ID)
3. Определи координаты ячейки:
   - colIndex — номер колонки с нужным показателем (по заголовкам)
   - rowIndex — номер строки с нужной категорией (по названиям строк + 1, т.к. строка 0 = заголовки)
4. Важно:
   - Первая строка (rowIndex=0) всегда содержит заголовки колонок
   - Названия строк начинаются с row_1, что соответствует rowIndex=1
   - Например: если нужен "row_5", то rowIndex=5
5. Верни ответ ТОЛЬКО в формате JSON

ФОРМАТ ОТВЕТА:
{
  "cell": {
    "viewId": 852,
    "colIndex": 2,
    "rowIndex": 5
  },
  "metadata": {
    "viewName": "Название представления",
    "sectionName": "Название раздела",
    "statformName": "Название статформы"
  },
  "reasoning": "Пояснение: почему выбрана именно эта ячейка (опционально)"
}

ПРИМЕРЫ:

Пример 1:
Запрос: "Сколько учителей математики?"

Заголовки: col_0="№", col_1="Предмет", col_2="Всего учителей", col_3="Из них женщин"
Названия строк:
  row_1: "математики"
  row_2: "физики"
  row_3: "химии"

Ответ:
{
  "cell": {
    "viewId": 874,
    "colIndex": 2,
    "rowIndex": 1
  },
  "metadata": {
    "viewName": "Кадровый состав",
    "sectionName": "Сведения о кадрах",
    "statformName": "ОО-1"
  },
  "reasoning": "row_1 = 'математики' соответствует rowIndex=1, col_2 = 'Всего учителей'"
}

Пример 2:
Запрос: "Численность работников организаций"

Названия строк:
  row_1: "Численность работников – всего (сумма строк 02, 06, 43, 44)"
  row_2: "языка народов России и литературы"

Ответ:
{
  "cell": {
    "viewId": 875,
    "colIndex": 2,
    "rowIndex": 1
  },
  "reasoning": "row_1 содержит общую численность работников"
}`;
}

/**
 * Создать пользовательское сообщение для LLM
 * @param query - запрос пользователя
 * @param sectionName - название раздела
 * @param statformName - название статформы
 * @returns сообщение для LLM
 */
export function createViewCellSelectionMessage(
  query: string,
  sectionName: string,
  statformName: string
): string {
  return `Запрос пользователя: "${query}"

Контекст:
- Статформа: ${statformName}
- Раздел: ${sectionName}

Проанализируй структуру таблиц выше и определи координаты ячейки с нужными данными. Верни ответ в формате JSON.`;
}
