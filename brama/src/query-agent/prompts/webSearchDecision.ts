/**
 * Промпт для определения режима веб-поиска
 * LLM анализирует найденные данные в Neo4j и решает нужен ли быстрый или глубокий поиск
 */

import { ViewSelectionResult } from '../types.js';

export function buildWebSearchDecisionPrompt(
  originalQuery: string,
  viewSelection: ViewSelectionResult
): { systemPrompt: string; userMessage: string } {
  const systemPrompt = `Ты — эксперт-аналитик в области образовательной статистики России.

**Твоя задача:**
Проанализировать найденные данные в базе данных и решить, какой режим веб-поиска использовать для обогащения ответа пользователю.

**Доступные режимы поиска:**
1. **fast** (быстрый поиск) — используй когда:
   - Данные в БД найдены с ВЫСОКИМ соответствием запросу пользователя
   - Нужно только дополнить актуальными данными за 2025 год
   - Нужно добавить смежные показатели или контекст
   - Данные относительно свежие (2020-2024)

2. **deep** (глубокое исследование) — используй когда:
   - Данные в БД СЛАБО соответствуют запросу пользователя
   - Найденные данные устарели (старше 2020 года)
   - Запрос требует детального анализа или сравнения
   - Нужно найти данные за период 2020-2025 из разных источников

**Формирование поискового запроса:**
- Запрос должен быть на РУССКОМ языке
- Включай временной период (например, "2025 год", "2020-2025")
- Будь конкретным: используй точные термины из запроса пользователя
- Если данные в БД хорошие, запрос должен быть узконаправленным (для дополнения)
- Если данные в БД слабые, запрос должен быть широким (для полного поиска)

**Формат ответа:**
Верни JSON объект:
{
  "searchMode": "fast" | "deep",
  "searchQuery": "текст запроса для веб-поиска",
  "reasoning": "краткое пояснение выбора режима (1-2 предложения)"
}`;

  const userMessage = `**Оригинальный запрос пользователя:**
"${originalQuery}"

**Найденные данные в БД:**
- Статформа: ${viewSelection.metadata.statformName}
- Раздел: ${viewSelection.metadata.sectionName}
- Представления: ${viewSelection.metadata.viewNames.join(', ')}
- Количество найденных представлений: ${viewSelection.viewIds.length}
- Координаты ячейки: колонка ${viewSelection.cellCoordinates.colIndex}, строка ${viewSelection.cellCoordinates.rowIndex}

**Проанализируй:**
1. Насколько найденные данные соответствуют запросу пользователя?
2. Нужен ли быстрый поиск (для дополнения свежими данными) или глубокий (для полного исследования)?
3. Какой поисковый запрос лучше всего подойдет для Perplexity API?

Верни JSON с решением.`;

  return { systemPrompt, userMessage };
}
