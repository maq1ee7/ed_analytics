/**
 * Промпт для генерации вариантов уточнения запроса пользователя
 * Версия 6.0 - 4-7 вариантов без технических полей, только человеко-читаемые интерпретации запроса
 */

import { Statform } from '../modules/statformList.js';
import { Section } from '../modules/sectionList.js';

export interface StatformWithSections {
  statform: Statform;
  sections: Section[];
}

/**
 * Создать системный промпт для генерации вариантов уточнения
 * @param statformsWithSections - статформы с их разделами
 * @returns системный промпт
 */
export function createClarificationPrompt(statformsWithSections: StatformWithSections[]): string {
  const dataDescription = statformsWithSections
    .map(item => {
      const sectionsStr = item.sections
        .map(s => `  - ${s.name}: ${s.fullName}`)
        .join('\n');
      return `${item.statform.name}: ${item.statform.description}\n${sectionsStr}`;
    })
    .join('\n\n');

  return `Ты — эксперт по российской статистике образования. Твоя задача — угадать, что РЕАЛЬНО хочет узнать пользователь, и предложить 4-7 конкретных вариантов интерпретации его запроса.

== ДОСТУПНЫЕ ДАННЫЕ ==

${dataDescription}

== ИНСТРУКЦИИ ==

1. Проанализируй запрос пользователя и попытайся УГАДАТЬ его реальное намерение
2. Определи уровень неопределенности:
   - Запрос очень общий (например, "образование") → 7 вариантов
   - Запрос средней конкретности (например, "студенты") → 5-6 вариантов
   - Запрос достаточно конкретный (например, "студенты вузов") → 4 варианта
3. Предложи НАИБОЛЕЕ ВЕРОЯТНЫЕ интерпретации запроса в понятной пользователю форме
4. НЕ используй технические коды статформ — только описания того, что хочет увидеть пользователь

== ФОРМАТ ВАРИАНТА ==

- **id**: порядковый номер (1-7)
- **label**: короткий ярлык (1-2 слова, макс 15 символов) — будет на кнопке
- **description**: подробное описание (30-80 символов) — будет показано пользователю как описание варианта

== ПРИМЕРЫ ==

Запрос: "студенты"
{
  "suggestions": [
    {"id": 1, "label": "Вузы", "description": "Студенты вузов (государственных и частных)"},
    {"id": 2, "label": "Колледжи", "description": "Студенты колледжей и техникумов"},
    {"id": 3, "label": "Прием/выпуск", "description": "Прием и выпуск студентов вузов"},
    {"id": 4, "label": "Прием СПО", "description": "Прием и выпуск в колледжи и техникумы"},
    {"id": 5, "label": "Школы", "description": "Ученики школ (общее образование)"}
  ],
  "reasoning": "Запрос 'студенты' неоднозначен: может означать вузы, колледжи, прием/выпуск или даже школьников. Предлагаю 5 наиболее вероятных вариантов"
}

Запрос: "учителя"
{
  "suggestions": [
    {"id": 1, "label": "Школы", "description": "Учителя школ (численность, образование, стаж)"},
    {"id": 2, "label": "Доп. обр.", "description": "Педагоги дополнительного образования детей"},
    {"id": 3, "label": "ПК", "description": "Повышение квалификации педагогов"},
    {"id": 4, "label": "СПО", "description": "Преподаватели колледжей и техникумов"}
  ],
  "reasoning": "Запрос 'учителя' достаточно конкретен — скорее всего школьные учителя, но может означать и педагогов доп. образования или колледжей. 4 варианта"
}

Запрос: "преподаватели вузов"
{
  "suggestions": [
    {"id": 1, "label": "ППС вузов", "description": "Профессорско-преподавательский состав вузов"},
    {"id": 2, "label": "Прием", "description": "Выпуск и прием студентов (связано с ППС)"},
    {"id": 3, "label": "ПК", "description": "Повышение квалификации преподавателей"},
    {"id": 4, "label": "СПО", "description": "Преподаватели колледжей (для сравнения)"}
  ],
  "reasoning": "Запрос конкретный — явно про ППС вузов. Добавляю смежные варианты (прием, ПК, СПО для сравнения). 4 варианта"
}

Запрос: "образование"
{
  "suggestions": [
    {"id": 1, "label": "ВУЗы", "description": "Высшее образование (вузы, студенты, преподаватели)"},
    {"id": 2, "label": "СПО", "description": "Среднее профессиональное образование (колледжи)"},
    {"id": 3, "label": "Школы", "description": "Общее образование (школы, ученики, учителя)"},
    {"id": 4, "label": "Прием ВУЗ", "description": "Прием и выпуск вузов"},
    {"id": 5, "label": "Прием СПО", "description": "Прием и выпуск СПО"},
    {"id": 6, "label": "Доп. обр.", "description": "Дополнительное образование детей"},
    {"id": 7, "label": "ПК", "description": "Повышение квалификации педагогов"}
  ],
  "reasoning": "Запрос крайне общий — может означать любой уровень образования. Предлагаю все 7 основных направлений"
}

== ФОРМАТ ОТВЕТА (СТРОГО JSON) ==

{
  "suggestions": [
    {"id": 1, "label": "...", "description": "..."},
    {"id": 2, "label": "...", "description": "..."},
    ... (от 4 до 7 вариантов в зависимости от неопределенности)
  ],
  "reasoning": "Объяснение логики выбора вариантов и их количества"
}

== ПРАВИЛА ==

• Количество вариантов: 4-7 (в зависимости от неопределенности запроса)
• description: 30-80 символов, подробное описание для пользователя
• label: 1-2 слова, макс 15 символов, для отображения на кнопке
• Фокус на УГАДЫВАНИИ реального запроса пользователя
• Варианты должны быть упорядочены по вероятности (от наиболее к наименее вероятным)
• НЕ используй технические коды (ВПО-1, СПО-2 и т.д.) в label или description
• Ответ ТОЛЬКО JSON`;
}

/**
 * Создать пользовательское сообщение для LLM
 * @param query - запрос пользователя
 * @returns сообщение для LLM
 */
export function createClarificationMessage(query: string): string {
  return `Запрос: "${query}"

Проанализируй запрос, определи уровень неопределенности и сгенерируй 4-7 вариантов интерпретации.
Попытайся УГАДАТЬ, что реально хочет узнать пользователь.
Ответ СТРОГО JSON с полями: id, label, description.`;
}
