# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã Brama

> **–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 3.0
> **–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-11-20
> **–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –Ω–∞ LangGraph
> **–¶–µ–ª—å:** –û–ø–∏—Å–∞—Ç—å —Ç–µ–∫—É—â—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–µ—Ä–≤–∏—Å–µ Brama

---

## üìå –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç **—Ç–µ–∫—É—â—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é** —Å–µ—Ä–≤–∏—Å–∞ **brama** –Ω–∞ –æ—Å–Ω–æ–≤–µ **LangGraph**.

### –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (v3.0)

–°–∏—Å—Ç–µ–º–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ **LangGraph workflow** —Å 4 –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º–∏ —ç—Ç–∞–ø–∞–º–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞:

1. **QueryAgent** - –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ LangGraph (4 —ç—Ç–∞–ø–∞)
2. **DashboardService** - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π dashboard —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏
3. **Shared modules** - –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–ª–∏–µ–Ω—Ç—ã (LLM, Neo4j, Logger)

---

### üî¥ –ü–õ–ê–ù–ò–†–£–ï–ú–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –≠—Ç–∞–ø —É—Ç–æ—á–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞

> **‚ö†Ô∏è TODO:** –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —ç—Ç–∞–ø **–î–û** —Ç–µ–∫—É—â–µ–≥–æ workflow, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞ —É—Ç–æ—á–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–∑–µ.

**–ù–æ–≤—ã–π –ø–æ—Ç–æ–∫:**
```
User Query ‚Üí üî¥ clarifyQueryNode (–ù–û–í–´–ô) ‚Üí [4 –≤–∞—Ä–∏–∞–Ω—Ç–∞ —É—Ç–æ—á–Ω–µ–Ω–∏—è] ‚Üí User –≤—ã–±–∏—Ä–∞–µ—Ç ‚Üí –¢–µ–∫—É—â–∏–π workflow (4 —ç—Ç–∞–ø–∞)
```

### üîí –ù–µ–∏–∑–º–µ–Ω—è–µ–º—ã–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã

‚ùå **–°–∏–≥–Ω–∞—Ç—É—Ä–∞ `DashboardGenerator.generateDashboard(question: string)`** - –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
‚ùå **–§–æ—Ä–º–∞—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è `DashboardData`** - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å 2 –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ (linear + russia_map)

### –ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ

**–í–•–û–î:** –¢–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (string)
**–í–´–•–û–î:** –ì–æ—Ç–æ–≤—ã–π dashboard JSON (DashboardData)

### üìö –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

<details>
<summary><b>v2.0 ‚Üí v3.0: –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ LangGraph</b></summary>

#### –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:

**–°—Ç–∞—Ä–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (v2.0):**
- LLMService - –æ–¥–∏–Ω –≤—ã–∑–æ–≤ LLM –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∑–∞–ø—Ä–æ—Å–∞
- Neo4jService - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Neo4j
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: `{ form_code, view_type, section, col_index, row_index }`

**–ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (v3.0):**
- QueryAgent (LangGraph) - 4 –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —ç—Ç–∞–ø–∞ —Å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–º–∏ –≤—ã–∑–æ–≤–∞–º–∏ LLM
- DashboardService - –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–π –∏ —É–ª—É—á—à–µ–Ω–Ω—ã–π Neo4jService
- Shared modules - –≤—ã–¥–µ–ª–µ–Ω—ã –æ–±—â–∏–µ –∫–ª–∏–µ–Ω—Ç—ã
- –ù–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: `{ statformIds[], sectionId, viewId, colIndex, rowIndex, metadata }`

#### –ü–æ—á–µ–º—É –∏–∑–º–µ–Ω–∏–ª–∏:

‚úÖ **–¢–æ—á–Ω–æ—Å—Ç—å:** –ü–æ—à–∞–≥–æ–≤—ã–π –≤—ã–±–æ—Ä —Å—Ç–∞—Ç—Ñ–æ—Ä–º—ã ‚Üí —Ä–∞–∑–¥–µ–ª–∞ ‚Üí –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è ‚Üí —è—á–µ–π–∫–∏
‚úÖ **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å:** –ö–∞–∂–¥—ã–π —ç—Ç–∞–ø —Å reasoning –æ—Ç LLM
‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:** LangGraph –ø–æ–∑–≤–æ–ª—è–µ—Ç –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —ç—Ç–∞–ø—ã
‚úÖ **–¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LangSmith –∏–∑ –∫–æ—Ä–æ–±–∫–∏
‚úÖ **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –û–±—â–∏–µ –∫–ª–∏–µ–Ω—Ç—ã –≤ shared –º–æ–¥—É–ª–µ

</details>

---

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

### üìñ –£—Ä–æ–≤–µ–Ω—å 1: –í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- [–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã](#–æ–±–∑–æ—Ä-—Å–∏—Å—Ç–µ–º—ã)
- [–û–±—â–∞—è —Å—Ö–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞](#–æ–±—â–∞—è-—Å—Ö–µ–º–∞-–æ–±—Ä–∞–±–æ—Ç–∫–∏-–∑–∞–ø—Ä–æ—Å–∞)
- [–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã](#–æ—Å–Ω–æ–≤–Ω—ã–µ-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã)

### üîß –£—Ä–æ–≤–µ–Ω—å 2: –î–µ—Ç–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- [LangGraph Workflow (4 —ç—Ç–∞–ø–∞)](#langgraph-workflow-4-—ç—Ç–∞–ø–∞)
- [–î–∏–∞–≥—Ä–∞–º–º—ã –∏ —Å—Ö–µ–º—ã](#–¥–∏–∞–≥—Ä–∞–º–º—ã-–∏-—Å—Ö–µ–º—ã)
  - [–î–∏–∞–≥—Ä–∞–º–º–∞ 1: Sequence Diagram - –ü–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω](#–¥–∏–∞–≥—Ä–∞–º–º–∞-1-sequence-diagram---–ø–æ–ª–Ω—ã–π-–ø–∞–π–ø–ª–∞–π–Ω)
  - [–î–∏–∞–≥—Ä–∞–º–º–∞ 2: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª–µ–π](#–¥–∏–∞–≥—Ä–∞–º–º–∞-2-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–º–æ–¥—É–ª–µ–π)
  - [–î–∏–∞–≥—Ä–∞–º–º–∞ 3: State Flow - –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è](#–¥–∏–∞–≥—Ä–∞–º–º–∞-3-state-flow---–∏–∑–º–µ–Ω–µ–Ω–∏–µ-—Å–æ—Å—Ç–æ—è–Ω–∏—è)
  - [–î–∏–∞–≥—Ä–∞–º–º–∞ 4: ER –¥–∏–∞–≥—Ä–∞–º–º–∞ Neo4j](#–¥–∏–∞–≥—Ä–∞–º–º–∞-4-er-–¥–∏–∞–≥—Ä–∞–º–º–∞-neo4j)
  - [–î–∏–∞–≥—Ä–∞–º–º–∞ 5: LangGraph Architecture (Auto-generated)](#–¥–∏–∞–≥—Ä–∞–º–º–∞-5-langgraph-architecture-auto-generated)
- [QueryAgent (–∑–∞–º–µ–Ω–∞ LLMService)](#queryagent-–∑–∞–º–µ–Ω–∞-llmservice)
- [DashboardService (–∑–∞–º–µ–Ω–∞ Neo4jService)](#dashboardservice-–∑–∞–º–µ–Ω–∞-neo4jservice)
- [Shared Modules](#shared-modules)

### üìã –°–ø—Ä–∞–≤–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã](#–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ-–∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã)
- [–§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö DashboardData](#—Ñ–æ—Ä–º–∞—Ç-–¥–∞–Ω–Ω—ã—Ö-dashboarddata)
- [–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è](#–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ-–æ–∫—Ä—É–∂–µ–Ω–∏—è)
- [–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤](#–ø—Ä–∏–º–µ—Ä—ã-–∑–∞–ø—Ä–æ—Å–æ–≤-–∏-—Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)

---

## –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

–°–∏—Å—Ç–µ–º–∞ `ed_analytics` —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ —Ç—Ä–µ—Ö –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤:

1. **telegram-bot** - –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ Telegram
2. **backend** - —É–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å–∞–º–∏, –ë–î –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
3. **brama** - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç dashboard

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª—è brama

–ú–æ–¥—É–ª—å **brama** —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–µ–¥—É—é—â–∏–µ –∫–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

1. **DashboardGenerator** (`brama/src/utils/dashboardGenerator.ts`)
   - **–†–æ–ª—å**: –ì–ª–∞–≤–Ω—ã–π –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –ø—Ä–æ—Ü–µ—Å—Å–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ dashboard
   - **–ó–∞–¥–∞—á–∏**:
     - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç LLMService –∏ Neo4jService –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞
     - –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     - –í—ã–∑—ã–≤–∞–µ—Ç LLMService –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∑–∞–ø—Ä–æ—Å–∞
     - –í—ã–∑—ã–≤–∞–µ—Ç Neo4jService –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
     - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–π JSON dashboard
   - **–í–∞–∂–Ω–æ**: DashboardGenerator - —ç—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

2. **LLMService** (`brama/src/services/llmService.ts`)
   - **–†–æ–ª—å**: –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —è–∑—ã–∫–µ
   - **–í—Ö–æ–¥**: –¢–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - **–í—ã—Ö–æ–¥**: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (form_code, view_type, section, col_index, row_index)

3. **Neo4jService** (`brama/src/services/neo4jService.ts`)
   - **–†–æ–ª—å**: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Neo4j
   - **–í—Ö–æ–¥**: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ç LLMService
   - **–í—ã—Ö–æ–¥**: JSON dashboard —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏

---

## –û–±—â–∞—è —Å—Ö–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞

> **üí° –ö–∞–∫ —á–∏—Ç–∞—Ç—å —ç—Ç—É –¥–∏–∞–≥—Ä–∞–º–º—É:**
> - –£—á–∞—Å—Ç–Ω–∏–∫–∏ –ø–æ–∫–∞–∑–∞–Ω—ã —Å–≤–µ—Ä—Ö—É (User, Bot, Backend, Worker, ...)
> - –°—Ç—Ä–µ–ª–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã–∑–æ–≤–æ–≤ (‚Üí —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π, --‚Üí –æ—Ç–≤–µ—Ç)
> - –°–∏–Ω–∏–π –±–ª–æ–∫ = –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ Brama (LangGraph workflow)
> - –ö—Ä–∞—Å–Ω—ã–π –±–ª–æ–∫ = –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

```mermaid
sequenceDiagram
    participant User as üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å<br/>(Telegram)
    participant TgBot as üì± telegram-bot<br/>(Telegraf)
    participant Backend as üñ•Ô∏è backend<br/>(Express)
    participant Redis as üî¥ Redis<br/>(Bull Queue)
    participant Worker as ‚öôÔ∏è TaskProcessor<br/>(Bull Worker)
    participant DashGen as üéØ DashboardGenerator<br/>(–û–±–µ—Ä—Ç–∫–∞)
    participant QAgent as ü§ñ QueryAgent<br/>(LangGraph)
    participant DashSvc as üìä DashboardService
    participant Neo4j as üóÑÔ∏è Neo4j Database
    participant DB as üíæ PostgreSQL

    User->>TgBot: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    TgBot->>TgBot: –ü—Ä–æ–≤–µ—Ä–∫–∞ whitelist
    TgBot->>User: ‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∑–∞–ø—Ä–æ—Å...
    TgBot->>Backend: POST /api/queries/telegram<br/>{message, chatId}

    Backend->>DB: –°–æ–∑–¥–∞–µ—Ç Query –∑–∞–ø–∏—Å—å<br/>(status: 'pending')
    Backend->>DB: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç UID
    Backend->>TgBot: {uid: "xxx-xxx-xxx"}
    TgBot->>TgBot: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∞–∫—Ç–∏–≤–Ω—É—é —Å–µ—Å—Å–∏—é<br/>–ó–∞–ø—É—Å–∫–∞–µ—Ç 60s —Ç–∞–π–º–µ—Ä

    Backend->>Backend: üî¥ POST /api/clarify<br/>{taskId: uid, question}
    Backend->>Redis: üî¥ –î–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–¥–∞—á—É clarify –≤ Queue

    Note over Redis,Worker: Worker Pool (concurrency=2)

    Worker->>Redis: –ò–∑–≤–ª–µ–∫–∞–µ—Ç Job –∏–∑ –æ—á–µ—Ä–µ–¥–∏
    Worker->>DashGen: üî¥ getClarifications(question)
    DashGen->>QAgent: üî¥ clarifyQuery(question)

    rect rgb(255, 200, 200)
        Note over QAgent,Neo4j: üî¥ –ù–û–í–´–ô –≠–¢–ê–ü: –£–¢–û–ß–ù–ï–ù–ò–ï –ó–ê–ü–†–û–°–ê

        QAgent->>Neo4j: üî¥ –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –°–¢–ê–¢–§–û–†–ú + —Ä–∞–∑–¥–µ–ª—ã
        Neo4j-->>QAgent: [–°—Ç–∞—Ç—Ñ–æ—Ä–º—ã —Å –æ–ø–∏—Å–∞–Ω–∏—è–º–∏...]
        QAgent->>QAgent: üî¥ LLM –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞<br/>—É—Ç–æ—á–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
    end

    QAgent-->>DashGen: üî¥ ClarificationResult {suggestions: [...]}
    DashGen-->>Worker: üî¥ ClarificationResult
    Worker->>Backend: üî¥ POST /api/queries/callbacks/:uid<br/>{status: 'clarification_needed', suggestions}

    Backend->>DB: üî¥ –û–±–Ω–æ–≤–ª—è–µ—Ç Query (suggestions)
    Backend->>Redis: üî¥ –î–æ–±–∞–≤–ª—è–µ—Ç –≤ telegram-notifications

    Redis-->>TgBot: üî¥ {chatId, suggestions}
    TgBot->>User: üî¥ –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç:<br/>1Ô∏è‚É£ –í–∞—Ä–∏–∞–Ω—Ç 1<br/>2Ô∏è‚É£ –í–∞—Ä–∏–∞–Ω—Ç 2<br/>3Ô∏è‚É£ –í–∞—Ä–∏–∞–Ω—Ç 3<br/>4Ô∏è‚É£ –í–∞—Ä–∏–∞–Ω—Ç 4

    User->>TgBot: üî¥ –ù–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É –≤–∞—Ä–∏–∞–Ω—Ç–∞
    TgBot->>Backend: üî¥ POST /api/queries/:uid/select<br/>{selectedVariant: 2}

    Backend->>Backend: POST /api/process<br/>{taskId: uid, question: clarifiedQuery}
    Backend->>DB: –û–±–Ω–æ–≤–ª—è–µ—Ç status='processing'
    Backend->>Redis: –î–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–¥–∞—á—É –≤ Bull Queue

    Worker->>Redis: –ò–∑–≤–ª–µ–∫–∞–µ—Ç Job –∏–∑ –æ—á–µ—Ä–µ–¥–∏
    Worker->>DashGen: generateDashboard(clarifiedQuery)
    DashGen->>QAgent: processQuery(clarifiedQuery)

    rect rgb(240, 248, 255)
        Note over QAgent,Neo4j: LANGGRAPH WORKFLOW (4 —ç—Ç–∞–ø–∞)

        QAgent->>Neo4j: –≠—Ç–∞–ø 1: –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –°–¢–ê–¢–§–û–†–ú
        Neo4j-->>QAgent: [–û–û_1, –û–û_2, ...]
        QAgent->>QAgent: LLM –≤—ã–±–∏—Ä–∞–µ—Ç —Å—Ç–∞—Ç—Ñ–æ—Ä–º—É<br/>‚Üí statformIds: [852]

        QAgent->>Neo4j: –≠—Ç–∞–ø 2: –ü–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–¥–µ–ª—ã —Å—Ç–∞—Ç—Ñ–æ—Ä–º—ã
        Neo4j-->>QAgent: [–†–∞–∑–¥–µ–ª 1, –†–∞–∑–¥–µ–ª 2, ...]
        QAgent->>QAgent: LLM –≤—ã–±–∏—Ä–∞–µ—Ç —Ä–∞–∑–¥–µ–ª<br/>‚Üí sectionId: 123

        QAgent->>Neo4j: –≠—Ç–∞–ø 3: –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∞ + —Å—Ö–µ–º—É —Ç–∞–±–ª–∏—Ü—ã
        Neo4j-->>QAgent: [–¢–∞–±–ª–∏—Ü–∞ 1, ...] + –∑–∞–≥–æ–ª–æ–≤–∫–∏/—Å—Ç—Ä–æ–∫–∏
        QAgent->>QAgent: LLM –≤—ã–±–∏—Ä–∞–µ—Ç —è—á–µ–π–∫—É<br/>‚Üí viewId, colIndex, rowIndex

        QAgent->>DashSvc: –≠—Ç–∞–ø 4: generateDashboard({<br/>  viewId, colIndex, rowIndex,<br/>  metadata<br/>})
        DashSvc->>Neo4j: –ü–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≥–æ–¥—ã
        Neo4j-->>DashSvc: [2021, 2022, 2023, 2024]
        DashSvc->>Neo4j: –ò–∑–≤–ª–µ—á—å —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        Neo4j-->>DashSvc: data[year][row][col]
        DashSvc->>Neo4j: –ò–∑–≤–ª–µ—á—å —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        Neo4j-->>DashSvc: regions[region][year][row][col]
        DashSvc-->>QAgent: DashboardData {<br/>  charts: [linear, russia_map]<br/>}
    end

    QAgent-->>DashGen: DashboardData
    DashGen-->>Worker: DashboardData

    Worker->>Backend: POST /api/queries/callbacks/:uid<br/>{status: 'completed', result}

    Backend->>DB: –û–±–Ω–æ–≤–ª—è–µ—Ç Query<br/>(result, status='completed')
    Backend->>Redis: –î–æ–±–∞–≤–ª—è–µ—Ç –≤ telegram-notifications

    Redis-->>TgBot: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏–∑ –æ—á–µ—Ä–µ–¥–∏<br/>{chatId, uid, dashboardUrl}

    TgBot->>User: ‚úÖ –î–∞—à–±–æ—Ä–¥ –≥–æ—Ç–æ–≤!<br/><br/>üîó https://dashboard.url/uid
    TgBot->>TgBot: –û—á–∏—â–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—É—é —Å–µ—Å—Å–∏—é

    User->>User: –û—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å—Å—ã–ª–∫—É –≤ –±—Ä–∞—É–∑–µ—Ä–µ

    rect rgb(255, 240, 240)
        Note over User,DB: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π: –û—à–∏–±–∫–∞

        QAgent-->>Worker: throw Error("...")
        Worker->>Backend: POST /api/queries/callbacks/:uid<br/>{status: 'failed', error}
        Backend->>DB: –û–±–Ω–æ–≤–ª—è–µ—Ç status='failed'
        Backend->>Redis: –î–æ–±–∞–≤–ª—è–µ—Ç –≤ telegram-notifications
        TgBot->>User: ‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞:<br/>{error_message}
    end
```

> **üî¥ –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í –°–•–ï–ú–ï:**
> - –ù–æ–≤—ã–π endpoint `POST /api/clarify` –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ —É—Ç–æ—á–Ω–µ–Ω–∏–π
> - –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ `getClarifications()` –≤ DashboardGenerator
> - –ù–æ–≤—ã–π —ç—Ç–∞–ø `clarifyQuery` –≤ LangGraph (–∫—Ä–∞—Å–Ω—ã–π –±–ª–æ–∫)
> - –ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å `clarification_needed` –≤ callback
> - Inline –∫–Ω–æ–ø–∫–∏ –≤ Telegram –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞
> - –ù–æ–≤—ã–π endpoint `POST /api/queries/:uid/select` –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞

---

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. DashboardGenerator (`brama/src/utils/dashboardGenerator.ts`)

**–†–æ–ª—å:** –¢–æ–Ω–∫–∞—è –æ–±–µ—Ä—Ç–∫–∞ –∏ —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

**–ú–µ—Ç–æ–¥—ã:**
```typescript
class DashboardGenerator {
  static async initialize(): Promise<void>
  static async generateDashboard(question: string): Promise<DashboardData>
  static async shutdown(): Promise<void>
}
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- –ü—Ä–∏ `initialize()` —Å–æ–∑–¥–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä QueryAgent
- –ü—Ä–∏ `generateDashboard(question)` –¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ QueryAgent
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–π DashboardData

---

### 2. QueryAgent (`brama/src/query-agent/`)

**–†–æ–ª—å:** –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ LangGraph workflow (–∑–∞–º–µ–Ω–∞ LLMService)

**–û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥:**
```typescript
async processQuery(query: string): Promise<DashboardData>
```

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
- –ü–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ **LangGraph** (@langchain/langgraph)
- 4 –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —É–∑–ª–∞ (nodes)
- –ö–∞–∂–¥—ã–π —É–∑–µ–ª –æ–±–Ω–æ–≤–ª—è–µ—Ç –æ–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (State)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ LangSmith —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏

**–≠—Ç–∞–ø—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
1. `selectStatformNode` - –≤—ã–±–æ—Ä —Å—Ç–∞—Ç—Ñ–æ—Ä–º—ã
2. `selectSectionNode` - –≤—ã–±–æ—Ä —Ä–∞–∑–¥–µ–ª–∞
3. `selectViewCellsNode` - –≤—ã–±–æ—Ä –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∏ —è—á–µ–π–∫–∏
4. `generateDashboardNode` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è dashboard

---

### 3. DashboardService (`brama/src/dashboard-service/`)

**–†–æ–ª—å:** –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ dashboard —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ (–∑–∞–º–µ–Ω–∞ Neo4jService)

**–û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥:**
```typescript
async generateDashboard(input: DashboardServiceInput): Promise<DashboardData>
```

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
```typescript
interface DashboardServiceInput {
  query: string;           // –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
  viewId: number;          // ID –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
  colIndex: number;        // –ò–Ω–¥–µ–∫—Å –∫–æ–ª–æ–Ω–∫–∏
  rowIndex: number;        // –ò–Ω–¥–µ–∫—Å —Å—Ç—Ä–æ–∫–∏
  metadata: {
    viewName: string;
    sectionName: string;
    statformName: string;
  };
}
```

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≥–æ–¥—ã –∏–∑ Neo4j
2. –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–¥–ª—è –ª–∏–Ω–µ–π–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞)
3. –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–¥–ª—è –∫–∞—Ä—Ç—ã –†–æ—Å—Å–∏–∏)
4. –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–≤–∞ –≥—Ä–∞—Ñ–∏–∫–∞
5. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç DashboardData

---

### 4. Shared Modules (`brama/src/shared/`)

**LLMClient** - –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å LLM (DeepSeek —á–µ—Ä–µ–∑ AITunnel)
```typescript
chat(systemPrompt: string, userMessage: string, temperature?: number): Promise<string>
chatJSON<T>(systemPrompt: string, userMessage: string, schema: z.ZodType<T>, temperature?: number): Promise<T>
```

**Neo4jClient** - –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Neo4j (Singleton)
```typescript
executeQuery<T>(query: string, params?: Record<string, any>): Promise<T[]>
getAvailableYears(viewId: number): Promise<number[]>
getFederalData(viewId: number, years: number[]): Promise<Record<string, any[][]>>
getRegionalData(viewId: number, years: number[]): Promise<RegionalDataRow[]>
```

**Logger** - —Å–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å —É—Ä–æ–≤–Ω—è–º–∏
```typescript
debug(message: string, ...args: any[]): void
info(message: string, ...args: any[]): void
warn(message: string, ...args: any[]): void
error(message: string, error?: Error): void
```


---

## LangGraph Workflow (4 —ç—Ç–∞–ø–∞)

> **üí° –ß—Ç–æ —Ç–∞–∫–æ–µ LangGraph:**
> LangGraph - —ç—Ç–æ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è stateful workflows —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º LLM. Workflow –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –≥—Ä–∞—Ñ —É–∑–ª–æ–≤ (nodes), –≥–¥–µ –∫–∞–∂–¥—ã–π —É–∑–µ–ª –≤—ã–ø–æ–ª–Ω—è–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É—é –∑–∞–¥–∞—á—É –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –æ–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (State).

### üî¥ –¢–†–ï–ë–£–ï–¢–°–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ workflow

```typescript
interface QueryState {
  query: string;                      // –í—Ö–æ–¥–Ω–æ–π –∑–∞–ø—Ä–æ—Å

  // üî¥ –ù–û–í–û–ï –ü–û–õ–ï: –†–µ–∑—É–ª—å—Ç–∞—Ç —ç—Ç–∞–ø–∞ —É—Ç–æ—á–Ω–µ–Ω–∏—è
  clarification?: {
    suggestions: Array<{
      id: number;
      clarifiedQuery: string;      // –£—Ç–æ—á–Ω–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
      description: string;          // –û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      relevantStatforms: string[];  // –ö–∞–∫–∏–µ —Å—Ç–∞—Ç—Ñ–æ—Ä–º—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è
    }>;
    reasoning?: string;
  };

  statformSelection?: {               // –†–µ–∑—É–ª—å—Ç–∞—Ç —ç—Ç–∞–ø–∞ 1
    statformIds: number[];
    reasoning?: string;
  };
  sectionSelection?: {                // –†–µ–∑—É–ª—å—Ç–∞—Ç —ç—Ç–∞–ø–∞ 2
    sectionId: number;
    sectionName: string;
    reasoning?: string;
  };
  viewSelection?: {                   // –†–µ–∑—É–ª—å—Ç–∞—Ç —ç—Ç–∞–ø–∞ 3
    cell: {
      viewId: number;
      colIndex: number;
      rowIndex: number;
    };
    metadata: {
      viewName: string;
      sectionName: string;
      statformName: string;
    };
    reasoning?: string;
  };
  dashboardData?: DashboardData;      // –†–µ–∑—É–ª—å—Ç–∞—Ç —ç—Ç–∞–ø–∞ 4
  error?: string;
}
```

> **üî¥ –§–∞–π–ª –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:** `brama/src/query-agent/graph/state.ts`

---

### üî¥ –ù–û–í–´–ô –≠–¢–ê–ü 0: –£—Ç–æ—á–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ (clarifyQueryNode)

> **‚ö†Ô∏è –°–û–ó–î–ê–¢–¨ –ù–û–í–´–ô –§–ê–ô–õ:** `brama/src/query-agent/graph/nodes/clarifyQueryNode.ts`

**–¶–µ–ª—å:** –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞ —É—Ç–æ—á–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–∑–µ

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –°–¢–ê–¢–§–û–†–ú –∏ –∏—Ö —Ä–∞–∑–¥–µ–ª–æ–≤ –∏–∑ Neo4j
2. –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–ø—Ç —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
3. LLM –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞ —É—Ç–æ—á–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–ª—è –≤—ã–±–æ—Ä–∞ (–ù–ï –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç workflow!)

**–ü—Ä–∏–º–µ—Ä:**
```
–ó–∞–ø—Ä–æ—Å: "—à–∫–æ–ª—å–Ω–∏–∫–∏"
‚Üí LLM –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞:
  1. "–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∫–æ–ª—å–Ω–∏–∫–æ–≤ –ø–æ –≥–æ–¥–∞–º" (–û–û_1, –†–∞–∑–¥–µ–ª 1)
  2. "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∫–æ–ª—å–Ω–∏–∫–æ–≤ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º" (–û–û_1, –†–∞–∑–¥–µ–ª 1)
  3. "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–≤–æ–∫–ª–∞—Å—Å–Ω–∏–∫–æ–≤" (–û–û_1, –†–∞–∑–¥–µ–ª 2)
  4. "–®–∫–æ–ª—å–Ω–∏–∫–∏ —Å –æ—Å–æ–±—ã–º–∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è–º–∏" (–û–û_1, –†–∞–∑–¥–µ–ª 5)
```

**üî¥ –§–∞–π–ª—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- `brama/src/query-agent/graph/nodes/clarifyQueryNode.ts` ‚Äî –°–û–ó–î–ê–¢–¨
- `brama/src/query-agent/prompts/queryClarification.ts` ‚Äî –°–û–ó–î–ê–¢–¨
- `brama/src/query-agent/graph/graph.ts` ‚Äî –ò–ó–ú–ï–ù–ò–¢–¨ (–¥–æ–±–∞–≤–∏—Ç—å —É–∑–µ–ª)

---

### –≠—Ç–∞–ø 1: –í—ã–±–æ—Ä —Å—Ç–∞—Ç—Ñ–æ—Ä–º—ã (selectStatformNode)

**–¶–µ–ª—å:** –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫—É—é —Ñ–æ—Ä–º—É –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –°–¢–ê–¢–§–û–†–ú –∏–∑ Neo4j
2. –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–ø—Ç —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∫–∞–∂–¥–æ–π —Å—Ç–∞—Ç—Ñ–æ—Ä–º—ã
3. LLM –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –∏ –≤—ã–±–∏—Ä–∞–µ—Ç 1-2 —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Å—Ç–∞—Ç—Ñ–æ—Ä–º—ã
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å `statformIds[]` –≤ State

**–ü—Ä–∏–º–µ—Ä:**
```
–ó–∞–ø—Ä–æ—Å: "–°–∫–æ–ª—å–∫–æ —à–∫–æ–ª—å–Ω–∏–∫–æ–≤ –≤ –ú–æ—Å–∫–≤–µ?"
‚Üí LLM –≤—ã–±–∏—Ä–∞–µ—Ç: statformIds: [852] (–û–û_1)
‚Üí Reasoning: "–ó–∞–ø—Ä–æ—Å –∫–∞—Å–∞–µ—Ç—Å—è —à–∫–æ–ª—å–Ω–∏–∫–æ–≤, —á—Ç–æ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —Å—Ç–∞—Ç—Ñ–æ—Ä–º–µ –û–û_1"
```

---

### –≠—Ç–∞–ø 2: –í—ã–±–æ—Ä —Ä–∞–∑–¥–µ–ª–∞ (selectSectionNode)

**–¶–µ–ª—å:** –í—ã–±—Ä–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ä–∞–∑–¥–µ–ª –≤–Ω—É—Ç—Ä–∏ —Å—Ç–∞—Ç—Ñ–æ—Ä–º—ã

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ä–∞–∑–¥–µ–ª—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ç—Ñ–æ—Ä–º
2. –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–ø—Ç —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ —Ä–∞–∑–¥–µ–ª–æ–≤
3. LLM –≤—ã–±–∏—Ä–∞–µ—Ç –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ä–∞–∑–¥–µ–ª
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å `sectionId` –∏ `sectionName` –≤ State

**–ü—Ä–∏–º–µ—Ä:**
```
–ó–∞–ø—Ä–æ—Å: "–°–∫–æ–ª—å–∫–æ —à–∫–æ–ª—å–Ω–∏–∫–æ–≤ –≤ –ú–æ—Å–∫–≤–µ?"
‚Üí LLM –≤—ã–±–∏—Ä–∞–µ—Ç: sectionId: 123, sectionName: "–†–∞–∑–¥–µ–ª 1. –°–≤–µ–¥–µ–Ω–∏—è –æ–± –æ–±—É—á–∞—é—â–∏—Ö—Å—è"
‚Üí Reasoning: "–†–∞–∑–¥–µ–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –æ–±—É—á–∞—é—â–∏—Ö—Å—è"
```

---

### –≠—Ç–∞–ø 3: –í—ã–±–æ—Ä –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∏ —è—á–µ–π–∫–∏ (selectViewCellsNode)

**–¶–µ–ª—å:** –ù–∞–π—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —è—á–µ–π–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ —Å –Ω—É–∂–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π (view) –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞
2. –ü–æ–ª—É—á–∏—Ç—å —Å—Ö–µ–º—É —Ç–∞–±–ª–∏—Ü—ã (–∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–ª–æ–Ω–æ–∫ –∏ —Å—Ç—Ä–æ–∫)
3. –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–ø—Ç —Å–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π —Ç–∞–±–ª–∏—Ü—ã
4. LLM –≤—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —è—á–µ–π–∫–∏
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å `viewId`, `colIndex`, `rowIndex`, `metadata` –≤ State

**–ü—Ä–∏–º–µ—Ä:**
```
–ó–∞–ø—Ä–æ—Å: "–°–∫–æ–ª—å–∫–æ —à–∫–æ–ª—å–Ω–∏–∫–æ–≤ –≤ –ú–æ—Å–∫–≤–µ?"
‚Üí –°—Ö–µ–º–∞ —Ç–∞–±–ª–∏—Ü—ã:
  –ö–æ–ª–æ–Ω–∫–∏: ["‚Ññ", "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ", "–í—Å–µ–≥–æ", "1 –∫–ª–∞—Å—Å", "2 –∫–ª–∞—Å—Å", ...]
  –°—Ç—Ä–æ–∫–∏: ["–ú–æ—Å–∫–≤–∞", "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", ...]
‚Üí LLM –≤—ã–±–∏—Ä–∞–µ—Ç: viewId: 456, colIndex: 2 ("–í—Å–µ–≥–æ"), rowIndex: 1 ("–ú–æ—Å–∫–≤–∞")
‚Üí Metadata: { viewName: "–¢–∞–±–ª–∏—Ü–∞ 1", sectionName: "–†–∞–∑–¥–µ–ª 1", statformName: "–û–û_1" }
```

---

### –≠—Ç–∞–ø 4: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è dashboard (generateDashboardNode)

**–¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π dashboard —Å –¥–≤—É–º—è –≥—Ä–∞—Ñ–∏–∫–∞–º–∏

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –í—ã–∑–≤–∞—Ç—å DashboardService —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∏–∑ State
2. DashboardService –∏–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ Neo4j
3. –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –ª–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ (—Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
4. –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∫–∞—Ä—Ç—É –†–æ—Å—Å–∏–∏ (—Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å `dashboardData` –≤ State

**–ü—Ä–∏–º–µ—Ä:**
```
Input: { viewId: 456, colIndex: 2, rowIndex: 1, metadata: {...} }
‚Üí –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —è—á–µ–π–∫–∏ [1][2] –∑–∞ –≤—Å–µ –≥–æ–¥—ã
‚Üí –§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: { 2021: 1234, 2022: 1256, 2023: 1278, 2024: 1301 }
‚Üí –†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: { "RU-MOW": {...}, "RU-SPE": {...}, ... }
‚Üí Output: DashboardData —Å 2 –≥—Ä–∞—Ñ–∏–∫–∞–º–∏
```

---

## –î–∏–∞–≥—Ä–∞–º–º—ã –∏ —Å—Ö–µ–º—ã

### –î–∏–∞–≥—Ä–∞–º–º–∞ 1: Sequence Diagram - –ü–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω

> **üí° –ö–∞–∫ —á–∏—Ç–∞—Ç—å —ç—Ç—É –¥–∏–∞–≥—Ä–∞–º–º—É:**
> - **–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –æ—Å—å:** –£—á–∞—Å—Ç–Ω–∏–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ (Worker, QueryAgent, Neo4j)
> - **–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –æ—Å—å:** –í—Ä–µ–º—è (—Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑)
> - **–°—Ç—Ä–µ–ª–∫–∏ ‚Üí:** –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã
> - **–ü—É–Ω–∫—Ç–∏—Ä–Ω—ã–µ —Å—Ç—Ä–µ–ª–∫–∏ --‚Üí:** –û—Ç–≤–µ—Ç—ã
> - **–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏:** –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –±–ª–æ–∫–æ–≤
> - **Note:** –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –ø—Ä–æ—Ü–µ—Å—Å—É

```mermaid
sequenceDiagram
    participant Worker as ‚öôÔ∏è Worker
    participant QA as ü§ñ QueryAgent<br/>(LangGraph)
    participant Neo4j as üóÑÔ∏è Neo4j
    participant LLM as üß† DeepSeek LLM
    participant DS as üìä DashboardService

    Worker->>QA: processQuery(question)

    rect rgb(230, 240, 255)
        Note over QA,LLM: –≠–¢–ê–ü 1: –í—ã–±–æ—Ä –°–¢–ê–¢–§–û–†–ú–´
        QA->>Neo4j: MATCH (n:–°–¢–ê–¢–§–û–†–ú–ê) RETURN...
        Neo4j-->>QA: [–û–û_1, –û–û_2, ...]
        QA->>LLM: "–í—ã–±–µ—Ä–∏ —Å—Ç–∞—Ç—Ñ–æ—Ä–º—É –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞"
        LLM-->>QA: { statformIds: [852] }
        Note over QA: State.statformSelection = [852]
    end

    rect rgb(240, 250, 240)
        Note over QA,LLM: –≠–¢–ê–ü 2: –í—ã–±–æ—Ä –†–ê–ó–î–ï–õ–ê
        QA->>Neo4j: MATCH (s)-[:–°–û–î–ï–†–ñ–ò–¢]->(r)<br/>WHERE id(s) IN [852]
        Neo4j-->>QA: [–†–∞–∑–¥–µ–ª 1, –†–∞–∑–¥–µ–ª 2, ...]
        QA->>LLM: "–í—ã–±–µ—Ä–∏ —Ä–∞–∑–¥–µ–ª"
        LLM-->>QA: { sectionId: 123 }
        Note over QA: State.sectionSelection = 123
    end

    rect rgb(255, 245, 230)
        Note over QA,LLM: –≠–¢–ê–ü 3: –í—ã–±–æ—Ä –ü–†–ï–î–°–¢–ê–í–õ–ï–ù–ò–Ø –∏ –Ø–ß–ï–ô–ö–ò
        QA->>Neo4j: MATCH (r)-[:–°–û–î–ï–†–ñ–ò–¢]->(v)<br/>WHERE id(r) = 123
        Neo4j-->>QA: [View 1, View 2, ...]
        QA->>Neo4j: GET TABLE SCHEMA(viewId, year)
        Neo4j-->>QA: headers + rows
        QA->>LLM: "–í—ã–±–µ—Ä–∏ —è—á–µ–π–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ"
        LLM-->>QA: { viewId: 456, col: 2, row: 1 }
        Note over QA: State.viewSelection = {...}
    end

    rect rgb(240, 255, 240)
        Note over QA,DS: –≠–¢–ê–ü 4: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è DASHBOARD
        QA->>DS: generateDashboard(input)
        DS->>Neo4j: getAvailableYears(viewId)
        Neo4j-->>DS: [2021, 2022, 2023, 2024]
        DS->>Neo4j: getFederalData(viewId, years)
        Neo4j-->>DS: data[year][row][col]
        DS->>Neo4j: getRegionalData(viewId, years)
        Neo4j-->>DS: regions[region][year]
        DS-->>QA: DashboardData
        Note over QA: State.dashboardData = {...}
    end

    QA-->>Worker: DashboardData
```

---

### –î–∏–∞–≥—Ä–∞–º–º–∞ 2: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª–µ–π

> **üí° –ö–∞–∫ —á–∏—Ç–∞—Ç—å —ç—Ç—É –¥–∏–∞–≥—Ä–∞–º–º—É:**
> - **–î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏** –ø–æ–∫–∞–∑–∞–Ω—ã —Å `/` –≤ –∫–æ–Ω—Ü–µ
> - **–§–∞–π–ª—ã** –±–µ–∑ `/`
> - **–û—Ç—Å—Ç—É–ø—ã** –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å
> - `‚îú‚îÄ‚îÄ` –∏ `‚îî‚îÄ‚îÄ` –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –∏–µ—Ä–∞—Ä—Ö–∏—é

```
brama/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dashboardGenerator.ts       # üéØ –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (–æ–±–µ—Ä—Ç–∫–∞) üî¥ –ò–ó–ú–ï–ù–ò–¢–¨
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ query-agent/                    # ü§ñ –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞ (LangGraph)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts                    # QueryAgent –∫–ª–∞—Å—Å üî¥ –ò–ó–ú–ï–ù–ò–¢–¨
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types.ts                    # TypeScript –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã üî¥ –ò–ó–ú–ï–ù–ò–¢–¨
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ graph/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ graph.ts                # LangGraph workflow definition üî¥ –ò–ó–ú–ï–ù–ò–¢–¨
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ state.ts                # QueryState –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å üî¥ –ò–ó–ú–ï–ù–ò–¢–¨
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ nodes/                  # –£–∑–ª—ã –≥—Ä–∞—Ñ–∞
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ clarifyQueryNode.ts         # üî¥ –°–û–ó–î–ê–¢–¨ - –≠—Ç–∞–ø 0 (—É—Ç–æ—á–Ω–µ–Ω–∏–µ)
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ selectStatformNode.ts       # –≠—Ç–∞–ø 1
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ selectSectionNode.ts        # –≠—Ç–∞–ø 2
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ selectViewCellsNode.ts      # –≠—Ç–∞–ø 3
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ generateDashboardNode.ts    # –≠—Ç–∞–ø 4
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ prompts/                    # LLM –ø—Ä–æ–º–ø—Ç—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ queryClarification.ts   # üî¥ –°–û–ó–î–ê–¢–¨ - –ü—Ä–æ–º–ø—Ç –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ statformSelection.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sectionSelection.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ viewCellSelection.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ modules/                    # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ statformList.ts         # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—Ñ–æ—Ä–º
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ sectionList.ts          # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–æ–≤
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ viewList.ts             # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ schemaBuilder.ts        # –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å—Ö–µ–º—ã —Ç–∞–±–ª–∏—Ü—ã
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ dashboard-service/              # üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è dashboard
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts                    # –≠–∫—Å–ø–æ—Ä—Ç API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dashboardGenerator.ts       # –ì–ª–∞–≤–Ω—ã–π –∫–ª–∞—Å—Å
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cellExtractor.ts            # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π —è—á–µ–µ–∫
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types.ts                    # TypeScript –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ chartFormatters/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ linearChart.ts          # –õ–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ russiaMapChart.ts       # –ö–∞—Ä—Ç–∞ –†–æ—Å—Å–∏–∏
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ shared/                         # üîß –û–±—â–∏–µ –º–æ–¥—É–ª–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ llmClient.ts                # LLM –∫–ª–∏–µ–Ω—Ç (DeepSeek)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ neo4jClient.ts              # Neo4j –∫–ª–∏–µ–Ω—Ç (Singleton)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logger.ts                   # –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ queueService.ts             # Bull Queue
‚îÇ   ‚îú‚îÄ‚îÄ workers/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ taskProcessor.ts            # Worker –æ–±—Ä–∞–±–æ—Ç–∫–∏
‚îÇ   ‚îî‚îÄ‚îÄ server.ts                       # Express —Å–µ—Ä–≤–µ—Ä
‚îÇ
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îú‚îÄ‚îÄ regions.json                    # –î–∞–Ω–Ω—ã–µ —Ä–µ–≥–∏–æ–Ω–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ –°–ø–∏—Å–æ–∫_—Ç–∞–±–ª–∏—Ü_–û–û_1.csv
‚îÇ   ‚îî‚îÄ‚îÄ –°–ø–∏—Å–æ–∫_—Ç–∞–±–ª–∏—Ü_–û–û_2.csv
‚îÇ
‚îî‚îÄ‚îÄ logs/llm/                           # –õ–æ–≥–∏ LLM –∑–∞–ø—Ä–æ—Å–æ–≤
```

**–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `query-agent/` - **–ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞** (4 —ç—Ç–∞–ø–∞ LangGraph)
- `dashboard-service/` - **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è dashboard** (–∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö)
- `shared/` - **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–ª–∏–µ–Ω—Ç—ã** (LLM, Neo4j, Logger)

---

### –î–∏–∞–≥—Ä–∞–º–º–∞ 3: State Flow - –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è

> **üí° –ö–∞–∫ —á–∏—Ç–∞—Ç—å —ç—Ç—É –¥–∏–∞–≥—Ä–∞–º–º—É:**
> - **–û–≤–∞–ª—ã:** –£–∑–ª—ã –≥—Ä–∞—Ñ–∞ (—ç—Ç–∞–ø—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏)
> - **–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏:** –°–æ—Å—Ç–æ—è–Ω–∏–µ (State) –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞
> - **–°—Ç—Ä–µ–ª–∫–∏ ‚Üí:** –ü–µ—Ä–µ–¥–∞—á–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
> - **–°–∏–Ω–∏–π —Ü–≤–µ—Ç:** LLM —É–∑–ª—ã (–≤—ã–∑—ã–≤–∞—é—Ç DeepSeek)
> - **–ó–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç:** Data —É–∑–ª—ã (—Ä–∞–±–æ—Ç–∞—é—Ç —Å Neo4j)

```mermaid
graph TD
    Start([üöÄ START]) --> S0{{"üî¥ –ù–û–í–´–ô –≠—Ç–∞–ø 0<br/>clarifyQuery"}}

    S0 --> State0["üì¶ State<br/>query: string<br/>üî¥ clarification: {<br/>  suggestions: [4 –≤–∞—Ä–∏–∞–Ω—Ç–∞]<br/>}"]

    State0 --> UserChoice([üî¥ –í–æ–∑–≤—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é<br/>–¥–ª—è –≤—ã–±–æ—Ä–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞])

    UserChoice --> S1{{"üîπ –≠—Ç–∞–ø 1<br/>selectStatform"}}

    S1 --> State1["üì¶ State<br/>query: string (—É—Ç–æ—á–Ω–µ–Ω–Ω—ã–π)<br/>statformSelection: {<br/>  statformIds: [852]<br/>}"]

    State1 --> S2{{"üîπ –≠—Ç–∞–ø 2<br/>selectSection"}}

    S2 --> State2["üì¶ State<br/>query: string<br/>statformSelection: {...}<br/>sectionSelection: {<br/>  sectionId: 123,<br/>  sectionName: '–†–∞–∑–¥–µ–ª 1'<br/>}"]

    State2 --> S3{{"üîπ –≠—Ç–∞–ø 3<br/>selectViewCells"}}

    S3 --> State3["üì¶ State<br/>query: string<br/>statformSelection: {...}<br/>sectionSelection: {...}<br/>viewSelection: {<br/>  cell: {viewId, col, row},<br/>  metadata: {...}<br/>}"]

    State3 --> S4{{"üî∏ –≠—Ç–∞–ø 4<br/>generateDashboard"}}

    S4 --> State4["üì¶ State<br/>query: string<br/>statformSelection: {...}<br/>sectionSelection: {...}<br/>viewSelection: {...}<br/>dashboardData: {<br/>  dashboard: {<br/>    charts: [linear, map]<br/>  }<br/>}"]

    State4 --> End([‚úÖ END])

    style S0 fill:#FFCDD2
    style State0 fill:#FFCDD2
    style UserChoice fill:#FFCDD2
    style S1 fill:#E3F2FD
    style S2 fill:#E3F2FD
    style S3 fill:#E3F2FD
    style S4 fill:#E8F5E9
    style State1 fill:#FFF9C4
    style State2 fill:#FFF9C4
    style State3 fill:#FFF9C4
    style State4 fill:#C8E6C9
```

> **üî¥ –í–ê–ñ–ù–û:** –ü–æ—Å–ª–µ `clarifyQuery` workflow **–ü–†–ï–†–´–í–ê–ï–¢–°–Ø** –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é. –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –æ–¥–Ω–æ–≥–æ –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω–æ–π workflow (–≠—Ç–∞–ø—ã 1-4).

---

### –î–∏–∞–≥—Ä–∞–º–º–∞ 4: ER –î–∏–∞–≥—Ä–∞–º–º–∞ Neo4j

> **üí° –ö–∞–∫ —á–∏—Ç–∞—Ç—å —ç—Ç—É –¥–∏–∞–≥—Ä–∞–º–º—É:**
> - **–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏:** –£–∑–ª—ã (nodes) –≤ Neo4j
> - **–õ–∏–Ω–∏–∏ —Å —Ç–µ–∫—Å—Ç–æ–º:** –°–≤—è–∑–∏ (relationships)
> - **||--o{:** –û–¥–∏–Ω –∫–æ –º–Ω–æ–≥–∏–º (–æ–¥–∏–Ω –°–¢–ê–¢–§–û–†–ú–ê —Å–æ–¥–µ—Ä–∂–∏—Ç –º–Ω–æ–≥–æ –†–ê–ó–î–ï–õ–æ–≤)
> - **–ê—Ç—Ä–∏–±—É—Ç—ã:** –°–≤–æ–π—Å—Ç–≤–∞ —É–∑–ª–æ–≤ –∏–ª–∏ —Å–≤—è–∑–µ–π
> - **‚ö†Ô∏è –í–ê–ñ–ù–û:** –†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –°–í–Ø–ó–ò, –∞ –Ω–µ –≤ —É–∑–ª–µ –†–ï–ì–ò–û–ù!

```mermaid
erDiagram
    –°–¢–ê–¢–§–û–†–ú–ê ||--o{ –†–ê–ó–î–ï–õ : "[:–°–û–î–ï–†–ñ–ò–¢]"
    –†–ê–ó–î–ï–õ ||--o{ –ü–†–ï–î–°–¢–ê–í–õ–ï–ù–ò–ï : "[:–°–û–î–ï–†–ñ–ò–¢]"
    –ü–†–ï–î–°–¢–ê–í–õ–ï–ù–ò–ï ||--o{ –†–ï–ì–ò–û–ù : "[–±–µ–∑—ã–º—è–Ω–Ω–∞—è —Å–≤—è–∑—å]"

    –°–¢–ê–¢–§–û–†–ú–ê {
        string name "–û–û_1, –û–û_2"
        string description "–û–ø–∏—Å–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã"
        int id "Neo4j ID"
    }

    –†–ê–ó–î–ï–õ {
        string name "–ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ"
        string full_name "–ü–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ"
        int id "Neo4j ID"
    }

    –ü–†–ï–î–°–¢–ê–í–õ–ï–ù–ò–ï {
        string name "–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã"
        string view_type "–≥–æ—É_–≥–æ—Ä–æ–¥, –≥–æ—É_—Å–µ–ª–æ"
        array data_2021 "–§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ 2021"
        array data_2022 "–§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ 2022"
        array data_2023 "–§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ 2023"
        array data_2024 "–§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ 2024"
        int id "Neo4j ID"
    }

    –†–ï–ì–ò–û–ù {
        string unicode "RU-XXX (ISO 3166-2)"
        string name "–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞"
        string federalDistrict "–¶–§–û, –°–ó–§–û, –ü–§–û..."
    }
```

**‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–°–û–ë–ï–ù–ù–û–°–¢–¨ –°–•–ï–ú–´:**

–†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è **–ù–ï –≤ —É–∑–ª–µ –†–ï–ì–ò–û–ù**, –∞ –≤ **–°–í–Ø–ó–ò –º–µ–∂–¥—É –ü–†–ï–î–°–¢–ê–í–õ–ï–ù–ò–ï –∏ –†–ï–ì–ò–û–ù**!

```
(–ü–†–ï–î–°–¢–ê–í–õ–ï–ù–ò–ï)-[r {
  data_2021: [...],
  data_2022: [...],
  data_2023: [...],
  data_2024: [...]
}]->(–†–ï–ì–ò–û–ù)
```

**–ü—Ä–∏–º–µ—Ä Cypher –∑–∞–ø—Ä–æ—Å–∞:**
```cypher
MATCH (view)-[r]->(region)
WHERE id(view) = 456
RETURN
  region.unicode AS regionCode,
  r.data_2021 AS data_2021,    ‚Üê –¥–∞–Ω–Ω—ã–µ –≤ –°–í–Ø–ó–ò!
  r.data_2022 AS data_2022
```

**–§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –≤ data_YYYY:**
```typescript
// –ú–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ (—Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã)
[
  { col_0: 1, col_1: "–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏", col_2: 123.4, col_3: 567.8, ... },
  { col_0: 2, col_1: "–î—Ä—É–≥–∞—è —Å—Ç—Ä–æ–∫–∞", col_2: 234.5, col_3: 678.9, ... },
  ...
]

// –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç—Å—è –≤ –¥–≤—É–º–µ—Ä–Ω—ã–π –º–∞—Å—Å–∏–≤
[
  [1, "–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏", 123.4, 567.8, ...],
  [2, "–î—Ä—É–≥–∞—è —Å—Ç—Ä–æ–∫–∞", 234.5, 678.9, ...],
  ...
]

// –î–æ—Å—Ç—É–ø –∫ —è—á–µ–π–∫–µ: data[rowIndex][colIndex]
// –ü—Ä–∏–º–µ—Ä: data[1][2] = 123.4
```

---

### –î–∏–∞–≥—Ä–∞–º–º–∞ 5: LangGraph Architecture (Auto-generated)

> **üí° –ö–∞–∫ —á–∏—Ç–∞—Ç—å —ç—Ç—É –¥–∏–∞–≥—Ä–∞–º–º—É:**
> - **–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏:** –£–∑–ª—ã –≥—Ä–∞—Ñ–∞ (—ç—Ç–∞–ø—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏)
> - **–û–≤–∞–ª—ã:** –¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞ (__start__) –∏ –≤—ã—Ö–æ–¥–∞ (__end__)
> - **–°–ø–ª–æ—à–Ω—ã–µ —Å—Ç—Ä–µ–ª–∫–∏ ‚Üí:** –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã
> - **–ü—É–Ω–∫—Ç–∏—Ä–Ω—ã–µ —Å—Ç—Ä–µ–ª–∫–∏ -.->:** –£—Å–ª–æ–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã
> - **–¶–≤–µ—Ç–∞ —É–∑–ª–æ–≤:** –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —ç—Ç–∞–ø–∞–º (–ì–æ–ª—É–±–æ–π ‚Üí –ó–µ–ª–µ–Ω—ã–π ‚Üí –û—Ä–∞–Ω–∂–µ–≤—ã–π ‚Üí –§–∏–æ–ª–µ—Ç–æ–≤—ã–π)
> - **‚ö†Ô∏è –í–∞–∂–Ω–æ:** –≠—Ç–∞ –¥–∏–∞–≥—Ä–∞–º–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ LangGraph!

```mermaid
%%{init: {'flowchart': {'curve': 'linear'}}}%%
graph TD;
	__start__([<p>__start__</p>]):::first
	clarifyQuery(üî¥ clarifyQuery - –ù–û–í–´–ô):::clarifyQuery
	selectStatform(selectStatform)
	selectSection(selectSection)
	selectViewCells(selectViewCells)
	generateDashboard(generateDashboard)
	__end__([<p>__end__</p>]):::last
	__start__ --> clarifyQuery;
	clarifyQuery --> __end__;
	clarifyQuery -.->|"üî¥ –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"| selectStatform;
	generateDashboard --> __end__;
	selectStatform -.-> selectSection;
	selectStatform -.-> selectViewCells;
	selectStatform -.-> generateDashboard;
	selectStatform -.-> __end__;
	selectSection -.-> selectStatform;
	selectSection -.-> selectViewCells;
	selectSection -.-> generateDashboard;
	selectSection -.-> __end__;
	selectViewCells -.-> selectStatform;
	selectViewCells -.-> selectSection;
	selectViewCells -.-> generateDashboard;
	selectViewCells -.-> __end__;
	classDef clarifyQuery fill:#FFCDD2,stroke:#D32F2F,stroke-width:3px;
	classDef selectStatform fill:#E3F2FD;
	classDef selectSection fill:#E8F5E9;
	classDef selectViewCells fill:#FFF3E0;
	classDef generateDashboard fill:#F3E5F5;
```

> **üî¥ –ò–ó–ú–ï–ù–ï–ù–ò–ï:** –î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π —É–∑–µ–ª `clarifyQuery` –≤ –Ω–∞—á–∞–ª–æ –≥—Ä–∞—Ñ–∞. –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–Ω –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏ **–ü–†–ï–†–´–í–ê–ï–¢** workflow. –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ (selectStatform –∏ –¥–∞–ª–µ–µ) –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –æ–¥–Ω–æ–≥–æ –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.

**–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —ç—Ç–∞ –¥–∏–∞–≥—Ä–∞–º–º–∞:**

1. **–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞:** `__start__` ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ `selectStatform`
2. **–£—Å–ª–æ–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã:** –ö–∞–∂–¥—ã–π —É–∑–µ–ª –º–æ–∂–µ—Ç:
   - –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É (–ø—Ä–∏ —É—Å–ø–µ—Ö–µ)
   - –ü–µ—Ä–µ–π—Ç–∏ –∫ `__end__` (–ø—Ä–∏ –æ—à–∏–±–∫–µ)
   - –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–ª—É—á–∞—è—Ö –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–∏–º —ç—Ç–∞–ø–∞–º
3. **–§–∏–Ω–∞–ª—å–Ω—ã–π —ç—Ç–∞–ø:** `generateDashboard` ‚Üí –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ `__end__`

**–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –ø—É–Ω–∫—Ç–∏—Ä–Ω—ã—Ö —Å—Ç—Ä–µ–ª–æ–∫:**

LangGraph –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **—É—Å–ª–æ–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã** (conditional edges), –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —É–∑–ª–∞:
- –ï—Å–ª–∏ `state.error` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –∫ `__end__`
- –ò–Ω–∞—á–µ ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É–∑–ª—É

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã

### üîí –ù–µ–∏–∑–º–µ–Ω—è–µ–º—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç: DashboardGenerator

**–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ —Å–∏—Å—Ç–µ–º—ã** - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—É–±–ª–∏—á–Ω—ã–π API:

```typescript
class DashboardGenerator {
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞
  static async initialize(): Promise<void>

  // –ì–ª–∞–≤–Ω—ã–π –º–µ—Ç–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞
  static async generateDashboard(question: string): Promise<DashboardData>

  // Graceful shutdown
  static async shutdown(): Promise<void>
}
```

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- ‚úÖ –ú–µ—Ç–æ–¥ `generateDashboard` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç **—Ç–æ–ª—å–∫–æ** —Å—Ç—Ä–æ–∫—É (—Ç–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å)
- ‚úÖ –ú–µ—Ç–æ–¥ `generateDashboard` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **—Ç–æ–ª—å–∫–æ** DashboardData
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ **–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤** (concurrency=2)
- ‚úÖ –í—Å–µ –æ—à–∏–±–∫–∏ –Ω–∞ **—Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ** –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ Timeout: 60 —Å–µ–∫—É–Ω–¥ –Ω–∞ –≤–µ—Å—å –∑–∞–ø—Ä–æ—Å
- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ retry –æ—Ç Bull Queue)

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```typescript
static async generateDashboard(question: string): Promise<DashboardData> {
  if (!this.queryAgent) {
    throw new Error('QueryAgent –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
  }

  // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ QueryAgent
  return await this.queryAgent.processQuery(question);
}
```

---

---

## –§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö DashboardData

### üîí –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç)

```typescript
interface DashboardData {
  dashboard: {
    title: string;
    description: string;
    charts: ChartConfig[];  // –í–°–ï–ì–î–ê 2 —ç–ª–µ–º–µ–Ω—Ç–∞
  };
}

interface ChartConfig {
  type: string;        // 'linear' –∏–ª–∏ 'russia_map'
  title: string;
  data: any;
}
```

### –ì—Ä–∞—Ñ–∏–∫ 1: –õ–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ (Linear Chart)

**–¢–∏–ø:** `'linear'`

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:**
```typescript
{
  type: 'linear',
  title: '–õ–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫',
  data: {
    years: [
      {
        points: [
          { x: 2021, y: 1234.5 },    // –≥–æ–¥, –∑–Ω–∞—á–µ–Ω–∏–µ
          { x: 2022, y: 1456.7 },
          { x: 2023, y: null },       // null –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
          { x: 2024, y: 1678.9 }
        ]
      }
    ]
  }
}
```

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- ‚úÖ –ú–∞—Å—Å–∏–≤ `years` —Å–æ–¥–µ—Ä–∂–∏—Ç **—Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —ç–ª–µ–º–µ–Ω—Ç**
- ‚úÖ `points` - –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ `{x: –≥–æ–¥, y: –∑–Ω–∞—á–µ–Ω–∏–µ}`
- ‚úÖ `y` –º–æ–∂–µ—Ç –±—ã—Ç—å `number | null`
- ‚úÖ –ì–æ–¥—ã –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é

---

### –ì—Ä–∞—Ñ–∏–∫ 2: –ö–∞—Ä—Ç–∞ –†–æ—Å—Å–∏–∏ (Russia Map Chart)

**–¢–∏–ø:** `'russia_map'`

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:**
```typescript
{
  type: 'russia_map',
  title: '–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ –†–æ—Å—Å–∏–∏',
  data: {
    years: [
      {
        year: 2021,
        regions: [
          { regionCode: 'RU-MOW', value: 1234.5 },
          { regionCode: 'RU-SPE', value: 987.3 },
          { regionCode: 'RU-SVE', value: null },  // null –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
          // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–≥–∏–æ–Ω—ã
        ]
      },
      {
        year: 2022,
        regions: [ /* ... */ ]
      }
      // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –≥–æ–¥–∞
    ]
  }
}
```

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- ‚úÖ `years` - –º–∞—Å—Å–∏–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –≥–æ–¥–∞
- ‚úÖ `regionCode` –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO 3166-2:RU (`'RU-XXX'`)
  - –ü—Ä–∏–º–µ—Ä—ã: `'RU-MOW'` (–ú–æ—Å–∫–≤–∞), `'RU-SPE'` (–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥)
- ‚úÖ `value` –º–æ–∂–µ—Ç –±—ã—Ç—å `number | null`
- ‚úÖ –ù–µ –≤—Å–µ —Ä–µ–≥–∏–æ–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç (—Ç–æ–ª—å–∫–æ —Ç–µ, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)

---

### –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä DashboardData

```json
{
  "dashboard": {
    "title": "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∫–æ–ª—å–Ω–∏–∫–æ–≤",
    "description": "–î–∞–Ω–Ω—ã–µ –∏–∑ —Å—Ç–∞—Ç—Ñ–æ—Ä–º—ã '–û–û_1', —Ä–∞–∑–¥–µ–ª '–°–≤–µ–¥–µ–Ω–∏—è –æ–± –æ–±—É—á–∞—é—â–∏—Ö—Å—è', —Ç–∞–±–ª–∏—Ü–∞ '–¢–∞–±–ª–∏—Ü–∞ 1', –∫–æ–ª–æ–Ω–∫–∞ '–í—Å–µ–≥–æ', —Å—Ç—Ä–æ–∫–∞ '–ú–æ—Å–∫–≤–∞'",
    "charts": [
      {
        "type": "linear",
        "title": "–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –≥–æ–¥–∞–º",
        "data": {
          "years": [
            {
              "points": [
                { "x": 2021, "y": 5432 },
                { "x": 2022, "y": 5678 },
                { "x": 2023, "y": 5890 },
                { "x": 2024, "y": 6012 }
              ]
            }
          ]
        }
      },
      {
        "type": "russia_map",
        "title": "–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º",
        "data": {
          "years": [
            {
              "year": 2021,
              "regions": [
                { "regionCode": "RU-MOW", "value": 5432 },
                { "regionCode": "RU-SPE", "value": 3210 },
                { "regionCode": "RU-SVE", "value": 2100 }
              ]
            },
            {
              "year": 2022,
              "regions": [
                { "regionCode": "RU-MOW", "value": 5678 },
                { "regionCode": "RU-SPE", "value": 3345 },
                { "regionCode": "RU-SVE", "value": 2234 }
              ]
            }
          ]
        }
      }
    ]
  }
}
```

---

### –§–æ—Ä–º–∞—Ç callback –≤ Backend

–ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ dashboard, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ backend —á–µ—Ä–µ–∑ HTTP POST.

**URL:** `POST {callbackUrl}` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `http://backend:5000/api/queries/callbacks/:uid`)

**–£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç:**
```json
{
  "status": "completed",
  "result": {
    "dashboard": {
      "title": "...",
      "description": "...",
      "charts": [ /* 2 –≥—Ä–∞—Ñ–∏–∫–∞ */ ]
    }
  }
}
```

**–û—Ç–≤–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ:**
```json
{
  "status": "failed",
  "error": "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞"
}
```

**‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ:**
- Backend –æ–∂–∏–¥–∞–µ—Ç –ø–æ–ª–µ `result.dashboard.charts` –∫–∞–∫ –º–∞—Å—Å–∏–≤ –∏–∑ **—Ä–æ–≤–Ω–æ 2 —ç–ª–µ–º–µ–Ω—Ç–æ–≤**
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–æ–ª–∂–Ω–∞ **–≤ —Ç–æ—á–Ω–æ—Å—Ç–∏** —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É `DashboardData`
- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ **—Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ** –¥–ª—è –∫–æ–Ω–µ—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

```bash
# LLM API (DeepSeek —á–µ—Ä–µ–∑ AITunnel)
OPENAI_API_KEY=sk-aitunnel-xxxxxx        # API –∫–ª—é—á AITunnel (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
DEEPSEEK_MODEL=deepseek-chat             # –ú–æ–¥–µ–ª—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: deepseek-chat)

# Neo4j Database
NEO4J_URI=bolt://neo4j:7687              # URI –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: bolt://neo4j:7687)
NEO4J_USERNAME=neo4j                     # –õ–æ–≥–∏–Ω (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: neo4j)
NEO4J_PASSWORD=your_neo4j_password       # –ü–∞—Ä–æ–ª—å (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)

# Redis
REDIS_HOST=redis                         # –•–æ—Å—Ç Redis (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: redis)
REDIS_PORT=6379                          # –ü–æ—Ä—Ç Redis (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 6379)

# Backend
BACKEND_URL=http://backend:5000          # URL –¥–ª—è callback (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
```

---

### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

```bash
# Worker –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
WORKER_CONCURRENCY=2                     # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 2)
DEFAULT_YEAR=2024                        # –ì–æ–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 2024)

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
LOG_LEVEL=INFO                           # DEBUG | INFO | WARN | ERROR (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: INFO)

# LangSmith —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
LANGSMITH_API_KEY=lsv2_pt_xxx            # API –∫–ª—é—á LangSmith
LANGSMITH_TRACING=true                   # –í–∫–ª—é—á–∏—Ç—å —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫—É (true | false)
LANGSMITH_PROJECT=ed-analytics           # –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –≤ LangSmith
LANGSMITH_ENDPOINT=https://api.smith.langchain.com  # Endpoint LangSmith
```

---

### üîë –ü–æ–ª—É—á–µ–Ω–∏–µ API –∫–ª—é—á–µ–π

#### 1. AITunnel API Key

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ https://aitunnel.ru
2. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –∏–ª–∏ –≤–æ–π–¥–∏—Ç–µ
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª **API Keys**
4. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∫–ª—é—á
5. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–ª—é—á (—Ñ–æ—Ä–º–∞—Ç: `sk-aitunnel-...`)

**–°—Ç–æ–∏–º–æ—Å—Ç—å:** DeepSeek v3.2 - –æ–¥–∏–Ω –∏–∑ —Å–∞–º—ã—Ö –¥–µ—à–µ–≤—ã—Ö LLM –Ω–∞ —Ä—ã–Ω–∫–µ (~$0.001-0.002 –∑–∞ –∑–∞–ø—Ä–æ—Å)

#### 2. LangSmith API Key (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ https://smith.langchain.com
2. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –∏–ª–∏ –≤–æ–π–¥–∏—Ç–µ
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Settings ‚Üí API Keys**
4. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∫–ª—é—á
5. –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç –¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏

**–ó–∞—á–µ–º –Ω—É–∂–µ–Ω LangSmith:**
- –î–µ—Ç–∞–ª—å–Ω–∞—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –≤—Å–µ—Ö 4 —ç—Ç–∞–ø–æ–≤ LangGraph
- –ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ–º–ø—Ç–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤ LLM
- –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –î–µ–±–∞–≥–≥–∏–Ω–≥ –æ—à–∏–±–æ–∫

---

### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

–í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ —Ñ–∞–π–ª–∞ `.env` –ø—Ä–æ–µ–∫—Ç–∞.

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è .env
docker-compose restart brama

# –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞
docker-compose down
docker-compose up -d --build brama
```

---

---

## –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### –ü—Ä–∏–º–µ—Ä 1: –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –æ —à–∫–æ–ª—å–Ω–∏–∫–∞—Ö

**–í—Ö–æ–¥–Ω–æ–π –∑–∞–ø—Ä–æ—Å:**
```
"–°–∫–æ–ª—å–∫–æ —à–∫–æ–ª—å–Ω–∏–∫–æ–≤ –≤ –ú–æ—Å–∫–≤–µ?"
```

**–ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ (4 —ç—Ç–∞–ø–∞):**

1. **–≠—Ç–∞–ø 1 - –í—ã–±–æ—Ä –°–¢–ê–¢–§–û–†–ú–´:**
   - LLM –≤—ã–±–∏—Ä–∞–µ—Ç: `statformIds: [852]` (–û–û_1)
   - Reasoning: "–ó–∞–ø—Ä–æ—Å –∫–∞—Å–∞–µ—Ç—Å—è —à–∫–æ–ª—å–Ω–∏–∫–æ–≤"

2. **–≠—Ç–∞–ø 2 - –í—ã–±–æ—Ä –†–ê–ó–î–ï–õ–ê:**
   - LLM –≤—ã–±–∏—Ä–∞–µ—Ç: `sectionId: 123`, `sectionName: "–°–≤–µ–¥–µ–Ω–∏—è –æ–± –æ–±—É—á–∞—é—â–∏—Ö—Å—è"`
   - Reasoning: "–†–∞–∑–¥–µ–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –æ–±—É—á–∞—é—â–∏—Ö—Å—è"

3. **–≠—Ç–∞–ø 3 - –í—ã–±–æ—Ä –Ø–ß–ï–ô–ö–ò:**
   - LLM –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å—Ö–µ–º—É —Ç–∞–±–ª–∏—Ü—ã
   - –í—ã–±–∏—Ä–∞–µ—Ç: `viewId: 456`, `colIndex: 2` ("–í—Å–µ–≥–æ"), `rowIndex: 1` ("–ú–æ—Å–∫–≤–∞")

4. **–≠—Ç–∞–ø 4 - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è DASHBOARD:**
   - DashboardService –∏–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ —è—á–µ–π–∫–∏ [1][2] –∑–∞ –≤—Å–µ –≥–æ–¥—ã
   - –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç 2 –≥—Ä–∞—Ñ–∏–∫–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "dashboard": {
    "title": "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—É—á–∞—é—â–∏—Ö—Å—è",
    "description": "–î–∞–Ω–Ω—ã–µ –∏–∑ —Å—Ç–∞—Ç—Ñ–æ—Ä–º—ã '–û–û_1', —Ä–∞–∑–¥–µ–ª '–°–≤–µ–¥–µ–Ω–∏—è –æ–± –æ–±—É—á–∞—é—â–∏—Ö—Å—è', —Ç–∞–±–ª–∏—Ü–∞ '–¢–∞–±–ª–∏—Ü–∞ 1', –∫–æ–ª–æ–Ω–∫–∞ '–í—Å–µ–≥–æ', —Å—Ç—Ä–æ–∫–∞ '–ú–æ—Å–∫–≤–∞'",
    "charts": [
      {
        "type": "linear",
        "title": "–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –≥–æ–¥–∞–º",
        "data": {
          "years": [{
            "points": [
              {"x": 2021, "y": 125430},
              {"x": 2022, "y": 128675},
              {"x": 2023, "y": 131920},
              {"x": 2024, "y": 135165}
            ]
          }]
        }
      },
      {
        "type": "russia_map",
        "title": "–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º",
        "data": {
          "years": [
            {
              "year": 2021,
              "regions": [
                {"regionCode": "RU-MOW", "value": 125430},
                {"regionCode": "RU-SPE", "value": 78320},
                {"regionCode": "RU-SVE", "value": 42150}
              ]
            },
            {
              "year": 2022,
              "regions": [
                {"regionCode": "RU-MOW", "value": 128675},
                {"regionCode": "RU-SPE", "value": 79840},
                {"regionCode": "RU-SVE", "value": 43220}
              ]
            }
          ]
        }
      }
    ]
  }
}
```

---

### –ü—Ä–∏–º–µ—Ä 2: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

**–í—Ö–æ–¥–Ω–æ–π –∑–∞–ø—Ä–æ—Å:**
```
"–î–∏–Ω–∞–º–∏–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É—á–∏—Ç–µ–ª–µ–π –≤ –ß—É–∫–æ—Ç—Å–∫–æ–º –ê–û"
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç —Å null –∑–Ω–∞—á–µ–Ω–∏—è–º–∏:**
```json
{
  "dashboard": {
    "title": "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∏—Ç–µ–ª–µ–π",
    "description": "...",
    "charts": [
      {
        "type": "linear",
        "title": "–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –≥–æ–¥–∞–º",
        "data": {
          "years": [{
            "points": [
              {"x": 2021, "y": 456},
              {"x": 2022, "y": null},     // ‚Üê –î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
              {"x": 2023, "y": 478},
              {"x": 2024, "y": 492}
            ]
          }]
        }
      },
      {
        "type": "russia_map",
        "title": "–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º",
        "data": {
          "years": [
            {
              "year": 2021,
              "regions": [
                {"regionCode": "RU-CHU", "value": 456},
                {"regionCode": "RU-KAM", "value": 1234}
              ]
            },
            {
              "year": 2022,
              "regions": [
                {"regionCode": "RU-CHU", "value": null},  // ‚Üê –î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
                {"regionCode": "RU-KAM", "value": 1267}
              ]
            }
          ]
        }
      }
    ]
  }
}
```

**‚ö†Ô∏è –í–∞–∂–Ω–æ:**
- `null` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
- Frontend –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `null` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Ç–æ—á–∫—É –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ)

---

### –ü—Ä–∏–º–µ—Ä 3: –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏

**–í—Ö–æ–¥–Ω–æ–π –∑–∞–ø—Ä–æ—Å:**
```
"–°–∫–æ–ª—å–∫–æ –¥–∏–Ω–æ–∑–∞–≤—Ä–æ–≤ –≤ –ú–æ—Å–∫–≤–µ?"
```

**–û—Ç–≤–µ—Ç (–æ—à–∏–±–∫–∞):**
```json
{
  "status": "failed",
  "error": "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞. –í–æ–∑–º–æ–∂–Ω–æ, –≤—ã –∑–∞–ø—Ä–æ—Å–∏–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–æ—Ä–º–∞—Ö –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è."
}
```

---

## –í–∞–∂–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **‚è±Ô∏è Timeout: 60 —Å–µ–∫—É–Ω–¥**
   - –í–µ—Å—å –∑–∞–ø—Ä–æ—Å (–æ—Ç Telegram –±–æ—Ç–∞ –¥–æ callback) –¥–æ–ª–∂–µ–Ω –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è –∑–∞ 60 —Å–µ–∫—É–Ω–¥
   - –ò–Ω–∞—á–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç –æ—à–∏–±–∫—É "Timeout"

2. **üîÄ Concurrency: 2 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á–∏**
   - Worker Pool –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –º–∞–∫—Å–∏–º—É–º 2 –∑–∞–¥–∞—á–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
   - –ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å thread-safe

3. **‚ôªÔ∏è Retry –∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**
   - Bull –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç —É–ø–∞–≤—à–∏–µ –∑–∞–¥–∞—á–∏
   - –û–ø–µ—Ä–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º–∏ (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤ = —Ç–æ—Ç –∂–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç)

4. **üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Logger –∏–∑ shared –º–æ–¥—É–ª—è
   - –î–æ–±–∞–≤–ª—è–π—Ç–µ –ø—Ä–µ—Ñ–∏–∫—Å—ã –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
   - –õ–æ–≥–∏—Ä—É–π—Ç–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ INFO –æ—Å–Ω–æ–≤–Ω—ã–µ —ç—Ç–∞–ø—ã
   - –õ–æ–≥–∏—Ä—É–π—Ç–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ DEBUG –¥–µ—Ç–∞–ª–∏

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∫–æ–¥—É

‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ**
```typescript
throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞');
```

‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**
```typescript
if (!viewId || !colIndex || !rowIndex) {
  throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞');
}
```

‚úÖ **Graceful shutdown**
```typescript
static async shutdown() {
  await neo4jClient.shutdown();
  // –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
}
```

‚úÖ **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ TypeScript —Ç–∏–ø–æ–≤**
```typescript
interface DashboardData {
  dashboard: {
    title: string;
    description: string;
    charts: ChartConfig[];
  };
}
```

---

---

## üî¥ –°–í–û–î–ö–ê –ò–ó–ú–ï–ù–ï–ù–ò–ô: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç—Ç–∞–ø–∞ —É—Ç–æ—á–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞

### –§–∞–π–ª—ã –¥–ª—è –°–û–ó–î–ê–ù–ò–Ø:
| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|-----------|
| `brama/src/query-agent/graph/nodes/clarifyQueryNode.ts` | –ù–æ–≤—ã–π —É–∑–µ–ª LangGraph –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ 4 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ |
| `brama/src/query-agent/prompts/queryClarification.ts` | –ü—Ä–æ–º–ø—Ç –¥–ª—è LLM |

### –§–∞–π–ª—ã –¥–ª—è –ò–ó–ú–ï–ù–ï–ù–ò–Ø:
| –§–∞–π–ª | –ß—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å |
|------|-------------|
| `brama/src/query-agent/graph/state.ts` | –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `clarification` –≤ QueryState |
| `brama/src/query-agent/graph/graph.ts` | –î–æ–±–∞–≤–∏—Ç—å —É–∑–µ–ª `clarifyQuery` –≤ –≥—Ä–∞—Ñ |
| `brama/src/query-agent/index.ts` | –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `getClarifications(query)` |
| `brama/src/query-agent/types.ts` | –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `ClarificationResult` |
| `brama/src/utils/dashboardGenerator.ts` | –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `getClarifications(query)` |

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö (–≤–Ω–µ brama):
| –°–µ—Ä–≤–∏—Å | –ß—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å |
|--------|-------------|
| `backend` | –ù–æ–≤—ã–π endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É—Ç–æ—á–Ω–µ–Ω–∏–π |
| `telegram-bot` | UI –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è 4 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ (inline buttons) |

### –ù–æ–≤—ã–π API –∫–æ–Ω—Ç—Ä–∞–∫—Ç:
```typescript
// –ù–û–í–´–ô –º–µ—Ç–æ–¥ (–≤ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É)
DashboardGenerator.getClarifications(query: string): Promise<ClarificationResult>

interface ClarificationResult {
  suggestions: Array<{
    id: number;
    clarifiedQuery: string;      // –£—Ç–æ—á–Ω–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
    description: string;          // –û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    relevantStatforms: string[];  // –ö–∞–∫–∏–µ —Å—Ç–∞—Ç—Ñ–æ—Ä–º—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è
  }>;
}
```

---

## –ò—Ç–æ–≥–æ–≤—ã–π Checklist

### üîí –ù–µ–∏–∑–º–µ–Ω—è–µ–º—ã–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã
- [x] `DashboardGenerator.generateDashboard(question: string)` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
- [x] –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `DashboardData` —Å –ø–æ–ª–µ–º `dashboard.charts` (–º–∞—Å—Å–∏–≤ –∏–∑ **—Ä–æ–≤–Ω–æ 2 —ç–ª–µ–º–µ–Ω—Ç–æ–≤**)
- [x] –ü–µ—Ä–≤—ã–π –≥—Ä–∞—Ñ–∏–∫: `type: 'linear'`
- [x] –í—Ç–æ—Ä–æ–π –≥—Ä–∞—Ñ–∏–∫: `type: 'russia_map'`
- [x] –ö–æ–¥—ã —Ä–µ–≥–∏–æ–Ω–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ `'RU-XXX'` (ISO 3166-2:RU)

### ‚úÖ –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (v3.0)
- [x] QueryAgent –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ LangGraph
- [x] 4 –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —ç—Ç–∞–ø–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- [x] DashboardService –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π dashboard
- [x] Shared modules (LLMClient, Neo4jClient, Logger)
- [x] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ LangSmith —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏
- [x] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ (concurrency=2)
- [x] –í—Å–µ –æ—à–∏–±–∫–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- [x] Backend –ø–æ–ª—É—á–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON —á–µ—Ä–µ–∑ callback
- [x] Timeout 60 —Å–µ–∫—É–Ω–¥
- [x] –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π
