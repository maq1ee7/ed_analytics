name: Add YouGile Link to PR Description

on:
  pull_request:
    types: [opened, edited]

jobs:
  add-yougile-link:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    
    steps:
      - name: Extract ticket number
        id: extract-ticket
        run: |
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä —Ç–∏–∫–µ—Ç–∞ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –≤–µ—Ç–∫–∏
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          echo "Branch name: $BRANCH_NAME"
          
          # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ IT-XXX –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –≤–µ—Ç–∫–∏
          TICKET_ID=$(echo "$BRANCH_NAME" | grep -oE "IT-[0-9]+" | head -n 1 | tr '[:lower:]' '[:upper:]')
          
          if [ -z "$TICKET_ID" ]; then
            # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ –≤–µ—Ç–∫–µ, –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ PR
            PR_TITLE="${{ github.event.pull_request.title }}"
            echo "PR title: $PR_TITLE"
            TICKET_ID=$(echo "$PR_TITLE" | grep -oE "IT-[0-9]+" | head -n 1 | tr '[:lower:]' '[:upper:]')
          fi
          
          if [ -z "$TICKET_ID" ]; then
            echo "No ticket found"
            echo "ticket_id=" >> $GITHUB_OUTPUT
          else
            echo "Found ticket: $TICKET_ID"
            echo "ticket_id=$TICKET_ID" >> $GITHUB_OUTPUT
          fi

      - name: Update PR description
        if: steps.extract-ticket.outputs.ticket_id != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const ticketId = '${{ steps.extract-ticket.outputs.ticket_id }}';
            const ticketUrl = `https://ru.yougile.com/team/6a5451828538/%D0%B0%D0%B9%D1%82%D0%B8%D1%88%D0%B5%D1%87%D0%BA%D0%B0/%D0%92%D0%B5%D0%B1#${ticketId}`;
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ PR
            const { data: pullRequest } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            let body = pullRequest.body || '';
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤—É—é —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–∏–∫–µ—Ç
            const ticketLink = `üìã **–¢–∏–∫–µ—Ç:** [${ticketId}](${ticketUrl})\n\n---\n\n`;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ç–∏–∫–µ—Ç –≤ –æ–ø–∏—Å–∞–Ω–∏–∏
            const ticketLinkRegex = /üìã \*\*–¢–∏–∫–µ—Ç:\*\* \[IT-\d+\]/;
            
            if (ticketLinkRegex.test(body)) {
              // –ó–∞–º–µ–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Å—ã–ª–∫—É
              body = body.replace(
                /üìã \*\*–¢–∏–∫–µ—Ç:\*\* \[IT-\d+\]\(https:\/\/ru\.yougile\.com[^\)]+\)\n\n---\n\n/,
                `üìã **–¢–∏–∫–µ—Ç:** [${ticketId}](${ticketUrl})\n\n---\n\n`
              );
              console.log(`üîÑ Updated ticket link for ${ticketId}`);
            } else {
              // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Å—Å—ã–ª–∫—É –≤ –Ω–∞—á–∞–ª–æ
              body = ticketLink + body;
              console.log(`‚úÖ Added ticket link for ${ticketId}`);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ PR
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              body: body
            });

