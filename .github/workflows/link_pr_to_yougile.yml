name: Link PR to YouGile Task
on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  update-yougile-task:
    runs-on: ubuntu-latest
    steps:
      - name: Extract PR info
        id: extract-pr
        run: |
          echo "PR_NUMBER=${{ github.event.number }}" >> $GITHUB_ENV
          echo "PR_TITLE=${{ github.event.pull_request.title }}" >> $GITHUB_ENV
          echo "PR_URL=${{ github.event.pull_request.html_url }}" >> $GITHUB_ENV
          echo "PR_BODY=${{ github.event.pull_request.body }}" >> $GITHUB_ENV

      - name: Find YouGile Task ID
        id: find-task
        run: |
          TICKET_ID=$(echo "$PR_TITLE $PR_BODY" | grep -oE "IT-[0-9]+" | head -n 1 | tr '[:lower:]' '[:upper:]')
          if [ -z "$TICKET_ID" ]; then
            echo "No YouGile task ID found in PR."
            exit 0
          else
            echo "Found YouGile Task ID: $TICKET_ID"
            echo "TICKET_ID=$TICKET_ID" >> $GITHUB_ENV
          fi

      - name: Get current task description from YouGile
        if: env.TICKET_ID != ''
        id: get-description
        run: |
          RESPONSE=$(curl -s -X GET \
            "https://ru.yougile.com/api-v2/tasks/${{ env.TICKET_ID }}" \
            -H "Authorization: Bearer ${{ secrets.YOUGILE_API_KEY }}" \
            -H "Content-Type: application/json")

          # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–ª—É—á–∞–π, –∫–æ–≥–¥–∞ –æ–ø–∏—Å–∞–Ω–∏–µ null –∏–ª–∏ –ø—É—Å—Ç–æ–µ
          CURRENT_DESCRIPTION=$(echo "$RESPONSE" | jq -r '.description')
          if [ "$CURRENT_DESCRIPTION" = "null" ] || [ -z "$CURRENT_DESCRIPTION" ]; then
            CURRENT_DESCRIPTION=""  # –ó–∞–º–µ–Ω—è–µ–º null –Ω–∞ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
          else
            # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∫–∞–≤—ã—á–∫–∏, –µ—Å–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –ø—É—Å—Ç–æ–µ
            CURRENT_DESCRIPTION=$(echo "$CURRENT_DESCRIPTION" | sed 's/"/\\"/g')
          fi
          echo "CURRENT_DESCRIPTION=$CURRENT_DESCRIPTION" >> $GITHUB_ENV

      - name: Update YouGile Task
        if: env.TICKET_ID != ''
        run: |
          # –§–æ—Ä–º–∏—Ä—É–µ–º –Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–±–µ–∑ "null" –≤ –Ω–∞—á–∞–ª–µ)
          UPDATED_DESCRIPTION="$CURRENT_DESCRIPTION\n\nüîó GitHub PR: #${{ env.PR_NUMBER }} (${{ env.PR_URL }})"

          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ YouGile
          curl -X PUT \
            "https://ru.yougile.com/api-v2/tasks/${{ env.TICKET_ID }}" \
            -H "Authorization: Bearer ${{ secrets.YOUGILE_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "description": "'"$UPDATED_DESCRIPTION"'"
            }'
